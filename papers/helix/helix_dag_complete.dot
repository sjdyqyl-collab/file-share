digraph Helix_16GPU_TwoLevel_Partitioning {
    rankdir=TB;
    node [shape=box, style=filled, fontname="Courier"];
    
    // Define GPU clusters with subgraphs
    subgraph cluster_0 {
        label="GPU 0 (Head Group 0, Dim 0)";
        color=lightblue;
        style=dashed;
        Q0; K0; V0; Attn0; Cat0_0;
    }
    subgraph cluster_1 {
        label="GPU 1 (Head Group 0, Dim 1)";
        color=lightblue;
        style=dashed;
        Q1; K1; V1; Attn1; Cat0_1;
    }
    subgraph cluster_2 {
        label="GPU 2 (Head Group 0, Dim 2)";
        color=lightblue;
        style=dashed;
        Q2; K2; V2; Attn2; Cat0_2;
    }
    subgraph cluster_3 {
        label="GPU 3 (Head Group 0, Dim 3)";
        color=lightblue;
        style=dashed;
        Q3; K3; V3; Attn3; Cat0_3;
    }
    subgraph cluster_4 {
        label="GPU 4 (Head Group 1, Dim 0)";
        color=lightgreen;
        style=dashed;
        Q4; K4; V4; Attn4; Cat1_0;
    }
    subgraph cluster_5 {
        label="GPU 5 (Head Group 1, Dim 1)";
        color=lightgreen;
        style=dashed;
        Q5; K5; V5; Attn5; Cat1_1;
    }
    subgraph cluster_6 {
        label="GPU 6 (Head Group 1, Dim 2)";
        color=lightgreen;
        style=dashed;
        Q6; K6; V6; Attn6; Cat1_2;
    }
    subgraph cluster_7 {
        label="GPU 7 (Head Group 1, Dim 3)";
        color=lightgreen;
        style=dashed;
        Q7; K7; V7; Attn7; Cat1_3;
    }
    subgraph cluster_8 {
        label="GPU 8 (Head Group 2, Dim 0)";
        color=lightyellow;
        style=dashed;
        Q8; K8; V8; Attn8; Cat2_0;
    }
    subgraph cluster_9 {
        label="GPU 9 (Head Group 2, Dim 1)";
        color=lightyellow;
        style=dashed;
        Q9; K9; V9; Attn9; Cat2_1;
    }
    subgraph cluster_10 {
        label="GPU 10 (Head Group 2, Dim 2)";
        color=lightyellow;
        style=dashed;
        Q10; K10; V10; Attn10; Cat2_2;
    }
    subgraph cluster_11 {
        label="GPU 11 (Head Group 2, Dim 3)";
        color=lightyellow;
        style=dashed;
        Q11; K11; V11; Attn11; Cat2_3;
    }
    subgraph cluster_12 {
        label="GPU 12 (Head Group 3, Dim 0)";
        color=lightcoral;
        style=dashed;
        Q12; K12; V12; Attn12; Cat3_0;
    }
    subgraph cluster_13 {
        label="GPU 13 (Head Group 3, Dim 1)";
        color=lightcoral;
        style=dashed;
        Q13; K13; V13; Attn13; Cat3_1;
    }
    subgraph cluster_14 {
        label="GPU 14 (Head Group 3, Dim 2)";
        color=lightcoral;
        style=dashed;
        Q14; K14; V14; Attn14; Cat3_2;
    }
    subgraph cluster_15 {
        label="GPU 15 (Head Group 3, Dim 3)";
        color=lightcoral;
        style=dashed;
        Q15; K15; V15; Attn15; Cat3_3;
    }
    
    // Input
    Input [label="Input X\n[B×L×D]\nD = h×d = 4096×128", shape=ellipse, fillcolor=white, penwidth=3];
    
    // Layer 1: MHA with two-level partitioning
    // Query projections (Column Parallel Linear - Megatron style)
    Q0 [label="Q Proj\nGPU0\nColParallel\nW_Q[0,0]\n[B×L×d_s×h_g]\nd_s=d/4=32, h_g=h/4=32", fillcolor=lightgreen];
    Q1 [label="Q Proj\nGPU1\nColParallel\nW_Q[0,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q2 [label="Q Proj\nGPU2\nColParallel\nW_Q[0,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q3 [label="Q Proj\nGPU3\nColParallel\nW_Q[0,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q4 [label="Q Proj\nGPU4\nColParallel\nW_Q[1,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q5 [label="Q Proj\nGPU5\nColParallel\nW_Q[1,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q6 [label="Q Proj\nGPU6\nColParallel\nW_Q[1,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q7 [label="Q Proj\nGPU7\nColParallel\nW_Q[1,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q8 [label="Q Proj\nGPU8\nColParallel\nW_Q[2,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q9 [label="Q Proj\nGPU9\nColParallel\nW_Q[2,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q10 [label="Q Proj\nGPU10\nColParallel\nW_Q[2,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q11 [label="Q Proj\nGPU11\nColParallel\nW_Q[2,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q12 [label="Q Proj\nGPU12\nColParallel\nW_Q[3,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q13 [label="Q Proj\nGPU13\nColParallel\nW_Q[3,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q14 [label="Q Proj\nGPU14\nColParallel\nW_Q[3,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    Q15 [label="Q Proj\nGPU15\nColParallel\nW_Q[3,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    
    // Key projections (Column Parallel Linear)
    K0 [label="K Proj\nGPU0\nColParallel\nW_K[0,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K1 [label="K Proj\nGPU1\nColParallel\nW_K[0,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K2 [label="K Proj\nGPU2\nColParallel\nW_K[0,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K3 [label="K Proj\nGPU3\nColParallel\nW_K[0,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K4 [label="K Proj\nGPU4\nColParallel\nW_K[1,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K5 [label="K Proj\nGPU5\nColParallel\nW_K[1,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K6 [label="K Proj\nGPU6\nColParallel\nW_K[1,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K7 [label="K Proj\nGPU7\nColParallel\nW_K[1,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K8 [label="K Proj\nGPU8\nColParallel\nW_K[2,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K9 [label="K Proj\nGPU9\nColParallel\nW_K[2,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K10 [label="K Proj\nGPU10\nColParallel\nW_K[2,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K11 [label="K Proj\nGPU11\nColParallel\nW_K[2,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K12 [label="K Proj\nGPU12\nColParallel\nW_K[3,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K13 [label="K Proj\nGPU13\nColParallel\nW_K[3,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K14 [label="K Proj\nGPU14\nColParallel\nW_K[3,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    K15 [label="K Proj\nGPU15\nColParallel\nW_K[3,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    
    // Value projections (Column Parallel Linear)
    V0 [label="V Proj\nGPU0\nColParallel\nW_V[0,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V1 [label="V Proj\nGPU1\nColParallel\nW_V[0,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V2 [label="V Proj\nGPU2\nColParallel\nW_V[0,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V3 [label="V Proj\nGPU3\nColParallel\nW_V[0,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V4 [label="V Proj\nGPU4\nColParallel\nW_V[1,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V5 [label="V Proj\nGPU5\nColParallel\nW_V[1,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V6 [label="V Proj\nGPU6\nColParallel\nW_V[1,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V7 [label="V Proj\nGPU7\nColParallel\nW_V[1,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V8 [label="V Proj\nGPU8\nColParallel\nW_V[2,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V9 [label="V Proj\nGPU9\nColParallel\nW_V[2,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V10 [label="V Proj\nGPU10\nColParallel\nW_V[2,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V11 [label="V Proj\nGPU11\nColParallel\nW_V[2,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V12 [label="V Proj\nGPU12\nColParallel\nW_V[3,0]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V13 [label="V Proj\nGPU13\nColParallel\nW_V[3,1]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V14 [label="V Proj\nGPU14\nColParallel\nW_V[3,2]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    V15 [label="V Proj\nGPU15\nColParallel\nW_V[3,3]\n[B×L×d_s×h_g]", fillcolor=lightgreen];
    
    // Attention computations for each partition
    Attn0 [label="Attention\nGPU0\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn1 [label="Attention\nGPU1\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn2 [label="Attention\nGPU2\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn3 [label="Attention\nGPU3\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn4 [label="Attention\nGPU4\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn5 [label="Attention\nGPU5\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn6 [label="Attention\nGPU6\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn7 [label="Attention\nGPU7\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn8 [label="Attention\nGPU8\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn9 [label="Attention\nGPU9\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn10 [label="Attention\nGPU10\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn11 [label="Attention\nGPU11\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn12 [label="Attention\nGPU12\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn13 [label="Attention\nGPU13\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn14 [label="Attention\nGPU14\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    Attn15 [label="Attention\nGPU15\nSoftmax(QK^T/√d_s)V\n[B×L×d_s×h_g]", fillcolor=orange];
    
    // Intra-head concatenation (within each head group)
    Cat0_0 [label="Concat Dim\nGPU0\nGather dims 0-3\n[B×L×d×h_g]", fillcolor=purple];
    Cat0_1 [label="Concat Dim\nGPU1\nGather dims 0-3\n[B