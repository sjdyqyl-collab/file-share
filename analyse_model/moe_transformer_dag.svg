<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="1800pt" height="613pt"
 viewBox="0.00 0.00 1800.00 612.60" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.28 0.28) rotate(0) translate(4 2221.34)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-2221.34 6534.74,-2221.34 6534.74,4 -4,4"/>
<!-- input_total -->
<g id="node1" class="node">
<title>input_total</title>
<ellipse fill="lightgreen" stroke="black" cx="2774" cy="-2190.47" rx="87.86" ry="26.74"/>
<text text-anchor="middle" x="2774" y="-2194.27" font-family="Times,serif" font-size="14.00">Input</text>
<text text-anchor="middle" x="2774" y="-2179.27" font-family="Times,serif" font-size="14.00">(B, L, d_model)</text>
</g>
<!-- split -->
<g id="node2" class="node">
<title>split</title>
<polygon fill="yellow" stroke="black" points="2913.92,-2126.6 2691.34,-2126.6 2634.08,-2050.6 2856.66,-2050.6 2913.92,-2126.6"/>
<text text-anchor="middle" x="2774" y="-2092.4" font-family="Times,serif" font-size="14.00">Split Sequence</text>
<text text-anchor="middle" x="2774" y="-2077.4" font-family="Times,serif" font-size="14.00">(B, L/P, d_model)</text>
</g>
<!-- input_total&#45;&gt;split -->
<g id="edge1" class="edge">
<title>input_total&#45;&gt;split</title>
<path fill="none" stroke="black" d="M2774,-2163.49C2774,-2155.34 2774,-2146.08 2774,-2136.94"/>
<polygon fill="black" stroke="black" points="2777.5,-2136.73 2774,-2126.73 2770.5,-2136.73 2777.5,-2136.73"/>
</g>
<!-- input_0 -->
<g id="node3" class="node">
<title>input_0</title>
<polygon fill="lightcyan" stroke="black" points="1031.5,-2013.6 894.5,-2013.6 894.5,-1960.6 1031.5,-1960.6 1031.5,-2013.6"/>
<text text-anchor="middle" x="963" y="-1998.4" font-family="Times,serif" font-size="14.00">Input Segment 0</text>
<text text-anchor="middle" x="963" y="-1983.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="963" y="-1968.4" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- split&#45;&gt;input_0 -->
<g id="edge2" class="edge">
<title>split&#45;&gt;input_0</title>
<path fill="none" stroke="black" d="M2656.92,-2081.17C2315.82,-2062.43 1328.94,-2008.21 1042.08,-1992.44"/>
<polygon fill="black" stroke="black" points="1041.94,-1988.93 1031.77,-1991.88 1041.56,-1995.92 1041.94,-1988.93"/>
</g>
<!-- input_1 -->
<g id="node32" class="node">
<title>input_1</title>
<polygon fill="lightcyan" stroke="black" points="2666.5,-2013.6 2529.5,-2013.6 2529.5,-1960.6 2666.5,-1960.6 2666.5,-2013.6"/>
<text text-anchor="middle" x="2598" y="-1998.4" font-family="Times,serif" font-size="14.00">Input Segment 1</text>
<text text-anchor="middle" x="2598" y="-1983.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2598" y="-1968.4" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- split&#45;&gt;input_1 -->
<g id="edge36" class="edge">
<title>split&#45;&gt;input_1</title>
<path fill="none" stroke="black" d="M2708.46,-2050.55C2689.99,-2040.1 2670.1,-2028.86 2652.35,-2018.83"/>
<polygon fill="black" stroke="black" points="2653.72,-2015.58 2643.29,-2013.7 2650.27,-2021.67 2653.72,-2015.58"/>
</g>
<!-- input_2 -->
<g id="node61" class="node">
<title>input_2</title>
<polygon fill="lightcyan" stroke="black" points="3348.5,-2013.6 3211.5,-2013.6 3211.5,-1960.6 3348.5,-1960.6 3348.5,-2013.6"/>
<text text-anchor="middle" x="3280" y="-1998.4" font-family="Times,serif" font-size="14.00">Input Segment 2</text>
<text text-anchor="middle" x="3280" y="-1983.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3280" y="-1968.4" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- split&#45;&gt;input_2 -->
<g id="edge70" class="edge">
<title>split&#45;&gt;input_2</title>
<path fill="none" stroke="black" d="M2870.37,-2068.65C2966.31,-2049.78 3111.8,-2021.17 3201.1,-2003.61"/>
<polygon fill="black" stroke="black" points="3202.04,-2007 3211.17,-2001.63 3200.69,-2000.13 3202.04,-2007"/>
</g>
<!-- input_3 -->
<g id="node90" class="node">
<title>input_3</title>
<polygon fill="lightcyan" stroke="black" points="4987.5,-2013.6 4850.5,-2013.6 4850.5,-1960.6 4987.5,-1960.6 4987.5,-2013.6"/>
<text text-anchor="middle" x="4919" y="-1998.4" font-family="Times,serif" font-size="14.00">Input Segment 3</text>
<text text-anchor="middle" x="4919" y="-1983.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="4919" y="-1968.4" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- split&#45;&gt;input_3 -->
<g id="edge104" class="edge">
<title>split&#45;&gt;input_3</title>
<path fill="none" stroke="black" d="M2881.1,-2082.63C3257.1,-2065.19 4511.78,-2006.99 4839.92,-1991.77"/>
<polygon fill="black" stroke="black" points="4840.45,-1995.25 4850.27,-1991.29 4840.12,-1988.26 4840.45,-1995.25"/>
</g>
<!-- qkv_proj_0 -->
<g id="node4" class="node">
<title>qkv_proj_0</title>
<polygon fill="lightblue" stroke="black" points="1112.5,-1923.6 813.5,-1923.6 813.5,-1870.6 1112.5,-1870.6 1112.5,-1923.6"/>
<text text-anchor="middle" x="963" y="-1908.4" font-family="Times,serif" font-size="14.00">QKV Projection</text>
<text text-anchor="middle" x="963" y="-1893.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 3*d_model)</text>
<text text-anchor="middle" x="963" y="-1878.4" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- input_0&#45;&gt;qkv_proj_0 -->
<g id="edge3" class="edge">
<title>input_0&#45;&gt;qkv_proj_0</title>
<path fill="none" stroke="black" d="M963,-1960.17C963,-1951.94 963,-1942.68 963,-1933.88"/>
<polygon fill="black" stroke="black" points="966.5,-1933.84 963,-1923.84 959.5,-1933.84 966.5,-1933.84"/>
</g>
<!-- residual_0 -->
<g id="node22" class="node">
<title>residual_0</title>
<polygon fill="pink" stroke="black" points="1060.5,-1069.74 923.5,-1069.74 923.5,-1016.74 1060.5,-1016.74 1060.5,-1069.74"/>
<text text-anchor="middle" x="992" y="-1054.54" font-family="Times,serif" font-size="14.00">Residual Add</text>
<text text-anchor="middle" x="992" y="-1039.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="992" y="-1024.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- input_0&#45;&gt;residual_0 -->
<g id="edge21" class="edge">
<title>input_0&#45;&gt;residual_0</title>
<path fill="none" stroke="black" d="M894.13,-1983.41C673.72,-1974.37 0,-1943.04 0,-1898.1 0,-1898.1 0,-1898.1 0,-1132.24 0,-1086.48 678.56,-1056.22 913.26,-1047.12"/>
<polygon fill="black" stroke="black" points="913.57,-1050.61 923.42,-1046.73 913.3,-1043.62 913.57,-1050.61"/>
</g>
<!-- split_qkv_0 -->
<g id="node5" class="node">
<title>split_qkv_0</title>
<polygon fill="yellow" stroke="black" points="1144.36,-1833.6 855.85,-1833.6 781.64,-1727.6 1070.15,-1727.6 1144.36,-1833.6"/>
<text text-anchor="middle" x="963" y="-1791.9" font-family="Times,serif" font-size="14.00">Split QKV</text>
<text text-anchor="middle" x="963" y="-1776.9" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="963" y="-1761.9" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- qkv_proj_0&#45;&gt;split_qkv_0 -->
<g id="edge4" class="edge">
<title>qkv_proj_0&#45;&gt;split_qkv_0</title>
<path fill="none" stroke="black" d="M963,-1870.4C963,-1862.46 963,-1853.34 963,-1844.04"/>
<polygon fill="black" stroke="black" points="966.5,-1843.92 963,-1833.92 959.5,-1843.92 966.5,-1843.92"/>
</g>
<!-- attn_stage_0_0 -->
<g id="node6" class="node">
<title>attn_stage_0_0</title>
<polygon fill="orange" stroke="black" points="1347,-1687.12 1105,-1687.12 1105,-1619.12 1347,-1619.12 1347,-1687.12"/>
<text text-anchor="middle" x="1226" y="-1671.92" font-family="Times,serif" font-size="14.00">Ring Attention Stage 0</text>
<text text-anchor="middle" x="1226" y="-1656.92" font-family="Times,serif" font-size="14.00">Q0 × K0 × V0</text>
<text text-anchor="middle" x="1226" y="-1641.92" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="1226" y="-1626.92" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- split_qkv_0&#45;&gt;attn_stage_0_0 -->
<g id="edge5" class="edge">
<title>split_qkv_0&#45;&gt;attn_stage_0_0</title>
<path fill="none" stroke="black" d="M1070.73,-1728.2C1096.39,-1715.96 1123.3,-1703.12 1147.37,-1691.64"/>
<polygon fill="black" stroke="black" points="1148.94,-1694.77 1156.45,-1687.3 1145.92,-1688.45 1148.94,-1694.77"/>
</g>
<!-- send_kv_0_0 -->
<g id="node7" class="node">
<title>send_kv_0_0</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="152" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="152" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU1</text>
<text text-anchor="middle" x="152" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="152" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- split_qkv_0&#45;&gt;send_kv_0_0 -->
<g id="edge6" class="edge">
<title>split_qkv_0&#45;&gt;send_kv_0_0</title>
<path fill="none" stroke="black" d="M807.84,-1765.35C669.77,-1751.22 462.76,-1726.47 285,-1690.6 273.36,-1688.25 261.23,-1685.44 249.25,-1682.44"/>
<polygon fill="black" stroke="black" points="249.78,-1678.97 239.23,-1679.88 248.05,-1685.75 249.78,-1678.97"/>
</g>
<!-- send_kv_0_1 -->
<g id="node11" class="node">
<title>send_kv_0_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="698" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="698" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU1</text>
<text text-anchor="middle" x="698" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="698" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- split_qkv_0&#45;&gt;send_kv_0_1 -->
<g id="edge9" class="edge">
<title>split_qkv_0&#45;&gt;send_kv_0_1</title>
<path fill="none" stroke="black" d="M852.92,-1727.48C825.93,-1714.7 797.67,-1701.32 772.79,-1689.53"/>
<polygon fill="black" stroke="black" points="773.96,-1686.22 763.42,-1685.1 770.96,-1692.54 773.96,-1686.22"/>
</g>
<!-- send_kv_0_2 -->
<g id="node15" class="node">
<title>send_kv_0_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="963" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="963" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU1</text>
<text text-anchor="middle" x="963" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="963" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- split_qkv_0&#45;&gt;send_kv_0_2 -->
<g id="edge13" class="edge">
<title>split_qkv_0&#45;&gt;send_kv_0_2</title>
<path fill="none" stroke="black" d="M963,-1727.48C963,-1718.57 963,-1709.37 963,-1700.63"/>
<polygon fill="black" stroke="black" points="966.5,-1700.61 963,-1690.61 959.5,-1700.61 966.5,-1700.61"/>
</g>
<!-- send_kv_0_3 -->
<g id="node19" class="node">
<title>send_kv_0_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="1489" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="1489" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU1</text>
<text text-anchor="middle" x="1489" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="1489" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- split_qkv_0&#45;&gt;send_kv_0_3 -->
<g id="edge17" class="edge">
<title>split_qkv_0&#45;&gt;send_kv_0_3</title>
<path fill="none" stroke="black" d="M1088.12,-1752.77C1165.5,-1735.8 1266.76,-1712.93 1356,-1690.6 1366.96,-1687.86 1378.39,-1684.89 1389.76,-1681.87"/>
<polygon fill="black" stroke="black" points="1390.96,-1685.17 1399.72,-1679.2 1389.15,-1678.41 1390.96,-1685.17"/>
</g>
<!-- accum_0_0 -->
<g id="node8" class="node">
<title>accum_0_0</title>
<polygon fill="lightgray" stroke="black" points="761.5,-1567.67 624.5,-1567.67 624.5,-1514.67 761.5,-1514.67 761.5,-1567.67"/>
<text text-anchor="middle" x="693" y="-1552.47" font-family="Times,serif" font-size="14.00">Initialize Output</text>
<text text-anchor="middle" x="693" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="693" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- attn_stage_0_0&#45;&gt;accum_0_0 -->
<g id="edge7" class="edge">
<title>attn_stage_0_0&#45;&gt;accum_0_0</title>
<path fill="none" stroke="black" d="M1112.11,-1619.05C1106.68,-1617.83 1101.29,-1616.68 1096,-1615.65 953.33,-1587.7 910.9,-1618.18 771,-1578.65 764.43,-1576.79 757.72,-1574.43 751.13,-1571.82"/>
<polygon fill="black" stroke="black" points="752.16,-1568.46 741.59,-1567.82 749.46,-1574.91 752.16,-1568.46"/>
</g>
<!-- accum_0_1 -->
<g id="node12" class="node">
<title>accum_0_1</title>
<polygon fill="lightgray" stroke="black" points="772,-1455.72 604,-1455.72 604,-1402.72 772,-1402.72 772,-1455.72"/>
<text text-anchor="middle" x="688" y="-1440.52" font-family="Times,serif" font-size="14.00">Accumulate Output 1</text>
<text text-anchor="middle" x="688" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="688" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- accum_0_0&#45;&gt;accum_0_1 -->
<g id="edge10" class="edge">
<title>accum_0_0&#45;&gt;accum_0_1</title>
<path fill="none" stroke="black" d="M691.84,-1514.67C691.18,-1500.2 690.35,-1481.87 689.63,-1465.98"/>
<polygon fill="black" stroke="black" points="693.12,-1465.79 689.17,-1455.96 686.13,-1466.11 693.12,-1465.79"/>
</g>
<!-- attn_stage_0_1 -->
<g id="node9" class="node">
<title>attn_stage_0_1</title>
<polygon fill="orange" stroke="black" points="568,-1575.17 326,-1575.17 326,-1507.17 568,-1507.17 568,-1575.17"/>
<text text-anchor="middle" x="447" y="-1559.97" font-family="Times,serif" font-size="14.00">Ring Attention Stage 1</text>
<text text-anchor="middle" x="447" y="-1544.97" font-family="Times,serif" font-size="14.00">Q0 × K3 × V3</text>
<text text-anchor="middle" x="447" y="-1529.97" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="447" y="-1514.97" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- attn_stage_0_1&#45;&gt;accum_0_1 -->
<g id="edge11" class="edge">
<title>attn_stage_0_1&#45;&gt;accum_0_1</title>
<path fill="none" stroke="black" d="M519.63,-1507.03C552.43,-1492.07 590.88,-1474.53 622.75,-1459.99"/>
<polygon fill="black" stroke="black" points="624.33,-1463.11 631.98,-1455.78 621.43,-1456.74 624.33,-1463.11"/>
</g>
<!-- recv_kv_0_1 -->
<g id="node10" class="node">
<title>recv_kv_0_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="425" cy="-1653.12" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="425" y="-1664.42" font-family="Times,serif" font-size="14.00">Receive K,V from GPU3</text>
<text text-anchor="middle" x="425" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="425" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- recv_kv_0_1&#45;&gt;attn_stage_0_1 -->
<g id="edge8" class="edge">
<title>recv_kv_0_1&#45;&gt;attn_stage_0_1</title>
<path fill="none" stroke="black" d="M432.33,-1615.51C434.28,-1605.76 436.4,-1595.15 438.41,-1585.1"/>
<polygon fill="black" stroke="black" points="441.84,-1585.78 440.37,-1575.29 434.98,-1584.41 441.84,-1585.78"/>
</g>
<!-- accum_0_2 -->
<g id="node16" class="node">
<title>accum_0_2</title>
<polygon fill="lightgray" stroke="black" points="995,-1347.24 827,-1347.24 827,-1294.24 995,-1294.24 995,-1347.24"/>
<text text-anchor="middle" x="911" y="-1332.04" font-family="Times,serif" font-size="14.00">Accumulate Output 2</text>
<text text-anchor="middle" x="911" y="-1317.04" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="911" y="-1302.04" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- accum_0_1&#45;&gt;accum_0_2 -->
<g id="edge14" class="edge">
<title>accum_0_1&#45;&gt;accum_0_2</title>
<path fill="none" stroke="black" d="M741.41,-1402.71C773.45,-1387.42 814.36,-1367.88 847.98,-1351.83"/>
<polygon fill="black" stroke="black" points="849.73,-1354.87 857.25,-1347.4 846.72,-1348.56 849.73,-1354.87"/>
</g>
<!-- attn_stage_0_2 -->
<g id="node13" class="node">
<title>attn_stage_0_2</title>
<polygon fill="orange" stroke="black" points="1032,-1463.22 790,-1463.22 790,-1395.22 1032,-1395.22 1032,-1463.22"/>
<text text-anchor="middle" x="911" y="-1448.02" font-family="Times,serif" font-size="14.00">Ring Attention Stage 2</text>
<text text-anchor="middle" x="911" y="-1433.02" font-family="Times,serif" font-size="14.00">Q0 × K2 × V2</text>
<text text-anchor="middle" x="911" y="-1418.02" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="911" y="-1403.02" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- attn_stage_0_2&#45;&gt;accum_0_2 -->
<g id="edge15" class="edge">
<title>attn_stage_0_2&#45;&gt;accum_0_2</title>
<path fill="none" stroke="black" d="M911,-1395.11C911,-1383.21 911,-1369.74 911,-1357.62"/>
<polygon fill="black" stroke="black" points="914.5,-1357.38 911,-1347.38 907.5,-1357.38 914.5,-1357.38"/>
</g>
<!-- recv_kv_0_2 -->
<g id="node14" class="node">
<title>recv_kv_0_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="911" cy="-1541.17" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="911" y="-1552.47" font-family="Times,serif" font-size="14.00">Receive K,V from GPU3</text>
<text text-anchor="middle" x="911" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="911" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- recv_kv_0_2&#45;&gt;attn_stage_0_2 -->
<g id="edge12" class="edge">
<title>recv_kv_0_2&#45;&gt;attn_stage_0_2</title>
<path fill="none" stroke="black" d="M911,-1503.56C911,-1493.91 911,-1483.42 911,-1473.46"/>
<polygon fill="black" stroke="black" points="914.5,-1473.34 911,-1463.34 907.5,-1473.34 914.5,-1473.34"/>
</g>
<!-- accum_0_3 -->
<g id="node20" class="node">
<title>accum_0_3</title>
<polygon fill="lightgray" stroke="black" points="1076,-1249.74 908,-1249.74 908,-1196.74 1076,-1196.74 1076,-1249.74"/>
<text text-anchor="middle" x="992" y="-1234.54" font-family="Times,serif" font-size="14.00">Accumulate Output 3</text>
<text text-anchor="middle" x="992" y="-1219.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="992" y="-1204.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- accum_0_2&#45;&gt;accum_0_3 -->
<g id="edge18" class="edge">
<title>accum_0_2&#45;&gt;accum_0_3</title>
<path fill="none" stroke="black" d="M932.71,-1294.15C942.24,-1282.91 953.56,-1269.56 963.74,-1257.56"/>
<polygon fill="black" stroke="black" points="966.43,-1259.79 970.23,-1249.9 961.1,-1255.27 966.43,-1259.79"/>
</g>
<!-- attn_stage_0_3 -->
<g id="node17" class="node">
<title>attn_stage_0_3</title>
<polygon fill="orange" stroke="black" points="1278,-1354.74 1036,-1354.74 1036,-1286.74 1278,-1286.74 1278,-1354.74"/>
<text text-anchor="middle" x="1157" y="-1339.54" font-family="Times,serif" font-size="14.00">Ring Attention Stage 3</text>
<text text-anchor="middle" x="1157" y="-1324.54" font-family="Times,serif" font-size="14.00">Q0 × K1 × V1</text>
<text text-anchor="middle" x="1157" y="-1309.54" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="1157" y="-1294.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- attn_stage_0_3&#45;&gt;accum_0_3 -->
<g id="edge19" class="edge">
<title>attn_stage_0_3&#45;&gt;accum_0_3</title>
<path fill="none" stroke="black" d="M1099.75,-1286.61C1082,-1276.33 1062.52,-1265.05 1045.06,-1254.95"/>
<polygon fill="black" stroke="black" points="1046.54,-1251.77 1036.14,-1249.79 1043.04,-1257.82 1046.54,-1251.77"/>
</g>
<!-- recv_kv_0_3 -->
<g id="node18" class="node">
<title>recv_kv_0_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="1181" cy="-1429.22" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="1181" y="-1440.52" font-family="Times,serif" font-size="14.00">Receive K,V from GPU3</text>
<text text-anchor="middle" x="1181" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="1181" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- recv_kv_0_3&#45;&gt;attn_stage_0_3 -->
<g id="edge16" class="edge">
<title>recv_kv_0_3&#45;&gt;attn_stage_0_3</title>
<path fill="none" stroke="black" d="M1172.74,-1391.57C1170.79,-1382.92 1168.69,-1373.62 1166.69,-1364.71"/>
<polygon fill="black" stroke="black" points="1170.08,-1363.87 1164.47,-1354.88 1163.25,-1365.41 1170.08,-1363.87"/>
</g>
<!-- output_proj_0 -->
<g id="node21" class="node">
<title>output_proj_0</title>
<polygon fill="lightblue" stroke="black" points="1134,-1159.74 850,-1159.74 850,-1106.74 1134,-1106.74 1134,-1159.74"/>
<text text-anchor="middle" x="992" y="-1144.54" font-family="Times,serif" font-size="14.00">Output Projection</text>
<text text-anchor="middle" x="992" y="-1129.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="992" y="-1114.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- accum_0_3&#45;&gt;output_proj_0 -->
<g id="edge20" class="edge">
<title>accum_0_3&#45;&gt;output_proj_0</title>
<path fill="none" stroke="black" d="M992,-1196.31C992,-1188.08 992,-1178.82 992,-1170.02"/>
<polygon fill="black" stroke="black" points="995.5,-1169.98 992,-1159.98 988.5,-1169.98 995.5,-1169.98"/>
</g>
<!-- output_proj_0&#45;&gt;residual_0 -->
<g id="edge22" class="edge">
<title>output_proj_0&#45;&gt;residual_0</title>
<path fill="none" stroke="black" d="M992,-1106.31C992,-1098.08 992,-1088.82 992,-1080.02"/>
<polygon fill="black" stroke="black" points="995.5,-1079.98 992,-1069.98 988.5,-1079.98 995.5,-1079.98"/>
</g>
<!-- ln1_0 -->
<g id="node23" class="node">
<title>ln1_0</title>
<polygon fill="lightyellow" stroke="black" points="1080.5,-979.74 943.5,-979.74 943.5,-926.74 1080.5,-926.74 1080.5,-979.74"/>
<text text-anchor="middle" x="1012" y="-964.54" font-family="Times,serif" font-size="14.00">Layer Norm 1</text>
<text text-anchor="middle" x="1012" y="-949.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="1012" y="-934.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- residual_0&#45;&gt;ln1_0 -->
<g id="edge23" class="edge">
<title>residual_0&#45;&gt;ln1_0</title>
<path fill="none" stroke="black" d="M997.89,-1016.31C999.76,-1008.08 1001.87,-998.82 1003.87,-990.02"/>
<polygon fill="black" stroke="black" points="1007.35,-990.51 1006.15,-979.98 1000.52,-988.96 1007.35,-990.51"/>
</g>
<!-- gate_0 -->
<g id="node24" class="node">
<title>gate_0</title>
<polygon fill="purple" stroke="black" points="1273.5,-889.74 1040.5,-889.74 1040.5,-836.74 1273.5,-836.74 1273.5,-889.74"/>
<text text-anchor="middle" x="1157" y="-874.54" font-family="Times,serif" font-size="14.00">MoE Gate</text>
<text text-anchor="middle" x="1157" y="-859.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 8)</text>
<text text-anchor="middle" x="1157" y="-844.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- ln1_0&#45;&gt;gate_0 -->
<g id="edge24" class="edge">
<title>ln1_0&#45;&gt;gate_0</title>
<path fill="none" stroke="black" d="M1054.33,-926.55C1070.56,-916.7 1089.24,-905.36 1106.19,-895.08"/>
<polygon fill="black" stroke="black" points="1108.14,-897.99 1114.87,-889.81 1104.5,-892.01 1108.14,-897.99"/>
</g>
<!-- expert_0_0 -->
<g id="node25" class="node">
<title>expert_0_0</title>
<polygon fill="lightcoral" stroke="black" points="1304,-789.74 812,-789.74 812,-736.74 1304,-736.74 1304,-789.74"/>
<text text-anchor="middle" x="1058" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 0</text>
<text text-anchor="middle" x="1058" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="1058" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- ln1_0&#45;&gt;expert_0_0 -->
<g id="edge26" class="edge">
<title>ln1_0&#45;&gt;expert_0_0</title>
<path fill="none" stroke="black" d="M1014.76,-926.71C1017.65,-903.1 1022.91,-867.18 1031,-836.74 1034.29,-824.37 1038.87,-811.16 1043.33,-799.45"/>
<polygon fill="black" stroke="black" points="1046.63,-800.61 1047.01,-790.02 1040.11,-798.06 1046.63,-800.61"/>
</g>
<!-- expert_0_1 -->
<g id="node26" class="node">
<title>expert_0_1</title>
<polygon fill="lightcoral" stroke="black" points="1814,-789.74 1322,-789.74 1322,-736.74 1814,-736.74 1814,-789.74"/>
<text text-anchor="middle" x="1568" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 1</text>
<text text-anchor="middle" x="1568" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="1568" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- ln1_0&#45;&gt;expert_0_1 -->
<g id="edge28" class="edge">
<title>ln1_0&#45;&gt;expert_0_1</title>
<path fill="none" stroke="black" d="M1080.65,-940.02C1135.81,-929.32 1214.87,-912.02 1282,-889.74 1362.43,-863.04 1451.26,-822.16 1508.25,-794.37"/>
<polygon fill="black" stroke="black" points="1510.03,-797.4 1517.46,-789.86 1506.94,-791.11 1510.03,-797.4"/>
</g>
<!-- residual2_0 -->
<g id="node29" class="node">
<title>residual2_0</title>
<polygon fill="pink" stroke="black" points="1321.5,-436.74 1184.5,-436.74 1184.5,-383.74 1321.5,-383.74 1321.5,-436.74"/>
<text text-anchor="middle" x="1253" y="-421.54" font-family="Times,serif" font-size="14.00">Residual Add 2</text>
<text text-anchor="middle" x="1253" y="-406.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="1253" y="-391.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- ln1_0&#45;&gt;residual2_0 -->
<g id="edge32" class="edge">
<title>ln1_0&#45;&gt;residual2_0</title>
<path fill="none" stroke="black" d="M943.28,-939.46C876.15,-924.96 784,-898.77 784,-864.24 784,-864.24 784,-864.24 784,-499.24 784,-460.03 1040.49,-430.69 1174.11,-418.06"/>
<polygon fill="black" stroke="black" points="1174.67,-421.52 1184.3,-417.11 1174.02,-414.55 1174.67,-421.52"/>
</g>
<!-- gate_0&#45;&gt;expert_0_0 -->
<g id="edge25" class="edge">
<title>gate_0&#45;&gt;expert_0_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1130.99,-836.49C1118.82,-824.45 1104.2,-809.97 1091.24,-797.15"/>
<polygon fill="black" stroke="black" points="1093.41,-794.36 1083.84,-789.82 1088.48,-799.34 1093.41,-794.36"/>
<text text-anchor="middle" x="1143" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- gate_0&#45;&gt;expert_0_1 -->
<g id="edge27" class="edge">
<title>gate_0&#45;&gt;expert_0_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1264.18,-836.68C1321.51,-823.01 1392.21,-806.16 1450.97,-792.15"/>
<polygon fill="black" stroke="black" points="1452.13,-795.47 1461.04,-789.74 1450.5,-788.66 1452.13,-795.47"/>
<text text-anchor="middle" x="1407" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- expert_agg_0 -->
<g id="node27" class="node">
<title>expert_agg_0</title>
<polygon fill="yellow" stroke="black" points="1416.61,-699.74 1156.34,-699.74 1089.39,-563.74 1349.66,-563.74 1416.61,-699.74"/>
<text text-anchor="middle" x="1253" y="-650.54" font-family="Times,serif" font-size="14.00">Expert Aggregation</text>
<text text-anchor="middle" x="1253" y="-635.54" font-family="Times,serif" font-size="14.00">Combine 2 experts</text>
<text text-anchor="middle" x="1253" y="-620.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="1253" y="-605.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- expert_0_0&#45;&gt;expert_agg_0 -->
<g id="edge29" class="edge">
<title>expert_0_0&#45;&gt;expert_agg_0</title>
<path fill="none" stroke="black" d="M1096.53,-736.66C1111.12,-726.96 1128.54,-715.4 1146.37,-703.56"/>
<polygon fill="black" stroke="black" points="1148.75,-706.18 1155.14,-697.73 1144.87,-700.35 1148.75,-706.18"/>
</g>
<!-- expert_0_1&#45;&gt;expert_agg_0 -->
<g id="edge30" class="edge">
<title>expert_0_1&#45;&gt;expert_agg_0</title>
<path fill="none" stroke="black" d="M1505.77,-736.66C1482.23,-726.98 1454.14,-715.43 1425.38,-703.61"/>
<polygon fill="black" stroke="black" points="1426.61,-700.33 1416.03,-699.76 1423.95,-706.8 1426.61,-700.33"/>
</g>
<!-- moe_output_0 -->
<g id="node28" class="node">
<title>moe_output_0</title>
<polygon fill="lightblue" stroke="black" points="1395,-526.74 1111,-526.74 1111,-473.74 1395,-473.74 1395,-526.74"/>
<text text-anchor="middle" x="1253" y="-511.54" font-family="Times,serif" font-size="14.00">MoE Output Projection</text>
<text text-anchor="middle" x="1253" y="-496.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="1253" y="-481.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- expert_agg_0&#45;&gt;moe_output_0 -->
<g id="edge31" class="edge">
<title>expert_agg_0&#45;&gt;moe_output_0</title>
<path fill="none" stroke="black" d="M1253,-563.71C1253,-554.51 1253,-545.38 1253,-537.04"/>
<polygon fill="black" stroke="black" points="1256.5,-536.98 1253,-526.98 1249.5,-536.98 1256.5,-536.98"/>
</g>
<!-- moe_output_0&#45;&gt;residual2_0 -->
<g id="edge33" class="edge">
<title>moe_output_0&#45;&gt;residual2_0</title>
<path fill="none" stroke="black" d="M1253,-473.31C1253,-465.08 1253,-455.82 1253,-447.02"/>
<polygon fill="black" stroke="black" points="1256.5,-446.98 1253,-436.98 1249.5,-446.98 1256.5,-446.98"/>
</g>
<!-- ln2_0 -->
<g id="node30" class="node">
<title>ln2_0</title>
<polygon fill="lightyellow" stroke="black" points="1995.5,-346.74 1858.5,-346.74 1858.5,-293.74 1995.5,-293.74 1995.5,-346.74"/>
<text text-anchor="middle" x="1927" y="-331.54" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1927" y="-316.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="1927" y="-301.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- residual2_0&#45;&gt;ln2_0 -->
<g id="edge34" class="edge">
<title>residual2_0&#45;&gt;ln2_0</title>
<path fill="none" stroke="black" d="M1321.65,-400.28C1447.63,-383.83 1714.99,-348.92 1848.18,-331.53"/>
<polygon fill="black" stroke="black" points="1848.85,-334.97 1858.31,-330.21 1847.94,-328.03 1848.85,-334.97"/>
</g>
<!-- output_seg_0 -->
<g id="node31" class="node">
<title>output_seg_0</title>
<polygon fill="lightcyan" stroke="black" points="2153.5,-256.74 2004.5,-256.74 2004.5,-203.74 2153.5,-203.74 2153.5,-256.74"/>
<text text-anchor="middle" x="2079" y="-241.54" font-family="Times,serif" font-size="14.00">Output Segment 0</text>
<text text-anchor="middle" x="2079" y="-226.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2079" y="-211.54" font-family="Times,serif" font-size="14.00">GPU_0</text>
</g>
<!-- ln2_0&#45;&gt;output_seg_0 -->
<g id="edge35" class="edge">
<title>ln2_0&#45;&gt;output_seg_0</title>
<path fill="none" stroke="black" d="M1971.37,-293.55C1988.39,-283.7 2007.97,-272.36 2025.74,-262.08"/>
<polygon fill="black" stroke="black" points="2027.93,-264.85 2034.83,-256.81 2024.43,-258.79 2027.93,-264.85"/>
</g>
<!-- gather -->
<g id="node119" class="node">
<title>gather</title>
<polygon fill="yellow" stroke="black" points="2569.13,-166.74 2296.9,-166.74 2226.87,-90.74 2499.1,-90.74 2569.13,-166.74"/>
<text text-anchor="middle" x="2398" y="-132.54" font-family="Times,serif" font-size="14.00">Gather All Segments</text>
<text text-anchor="middle" x="2398" y="-117.54" font-family="Times,serif" font-size="14.00">(B, L, d_model)</text>
</g>
<!-- output_seg_0&#45;&gt;gather -->
<g id="edge138" class="edge">
<title>output_seg_0&#45;&gt;gather</title>
<path fill="none" stroke="black" d="M2153.79,-205.91C2192.31,-193.9 2240.12,-178.98 2283.2,-165.55"/>
<polygon fill="black" stroke="black" points="2284.38,-168.85 2292.88,-162.53 2282.29,-162.16 2284.38,-168.85"/>
</g>
<!-- qkv_proj_1 -->
<g id="node33" class="node">
<title>qkv_proj_1</title>
<polygon fill="lightblue" stroke="black" points="2747.5,-1923.6 2448.5,-1923.6 2448.5,-1870.6 2747.5,-1870.6 2747.5,-1923.6"/>
<text text-anchor="middle" x="2598" y="-1908.4" font-family="Times,serif" font-size="14.00">QKV Projection</text>
<text text-anchor="middle" x="2598" y="-1893.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 3*d_model)</text>
<text text-anchor="middle" x="2598" y="-1878.4" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- input_1&#45;&gt;qkv_proj_1 -->
<g id="edge37" class="edge">
<title>input_1&#45;&gt;qkv_proj_1</title>
<path fill="none" stroke="black" d="M2598,-1960.17C2598,-1951.94 2598,-1942.68 2598,-1933.88"/>
<polygon fill="black" stroke="black" points="2601.5,-1933.84 2598,-1923.84 2594.5,-1933.84 2601.5,-1933.84"/>
</g>
<!-- residual_1 -->
<g id="node51" class="node">
<title>residual_1</title>
<polygon fill="pink" stroke="black" points="2230.5,-1069.74 2093.5,-1069.74 2093.5,-1016.74 2230.5,-1016.74 2230.5,-1069.74"/>
<text text-anchor="middle" x="2162" y="-1054.54" font-family="Times,serif" font-size="14.00">Residual Add</text>
<text text-anchor="middle" x="2162" y="-1039.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2162" y="-1024.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- input_1&#45;&gt;residual_1 -->
<g id="edge55" class="edge">
<title>input_1&#45;&gt;residual_1</title>
<path fill="none" stroke="black" d="M2529.17,-1983.38C2309.74,-1974.24 1641,-1942.73 1641,-1898.1 1641,-1898.1 1641,-1898.1 1641,-1132.24 1641,-1087.95 1937.48,-1060.41 2083.13,-1049.54"/>
<polygon fill="black" stroke="black" points="2083.64,-1053.02 2093.35,-1048.79 2083.12,-1046.04 2083.64,-1053.02"/>
</g>
<!-- split_qkv_1 -->
<g id="node34" class="node">
<title>split_qkv_1</title>
<polygon fill="yellow" stroke="black" points="2779.36,-1833.6 2490.85,-1833.6 2416.64,-1727.6 2705.15,-1727.6 2779.36,-1833.6"/>
<text text-anchor="middle" x="2598" y="-1791.9" font-family="Times,serif" font-size="14.00">Split QKV</text>
<text text-anchor="middle" x="2598" y="-1776.9" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="2598" y="-1761.9" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- qkv_proj_1&#45;&gt;split_qkv_1 -->
<g id="edge38" class="edge">
<title>qkv_proj_1&#45;&gt;split_qkv_1</title>
<path fill="none" stroke="black" d="M2598,-1870.4C2598,-1862.46 2598,-1853.34 2598,-1844.04"/>
<polygon fill="black" stroke="black" points="2601.5,-1843.92 2598,-1833.92 2594.5,-1843.92 2601.5,-1843.92"/>
</g>
<!-- attn_stage_1_0 -->
<g id="node35" class="node">
<title>attn_stage_1_0</title>
<polygon fill="orange" stroke="black" points="2191,-1687.12 1949,-1687.12 1949,-1619.12 2191,-1619.12 2191,-1687.12"/>
<text text-anchor="middle" x="2070" y="-1671.92" font-family="Times,serif" font-size="14.00">Ring Attention Stage 0</text>
<text text-anchor="middle" x="2070" y="-1656.92" font-family="Times,serif" font-size="14.00">Q1 × K1 × V1</text>
<text text-anchor="middle" x="2070" y="-1641.92" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="2070" y="-1626.92" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- split_qkv_1&#45;&gt;attn_stage_1_0 -->
<g id="edge39" class="edge">
<title>split_qkv_1&#45;&gt;attn_stage_1_0</title>
<path fill="none" stroke="black" d="M2427.58,-1743.59C2356.95,-1728.13 2274.32,-1709.32 2200,-1690.6 2198.75,-1690.29 2197.5,-1689.97 2196.24,-1689.65"/>
<polygon fill="black" stroke="black" points="2197.06,-1686.24 2186.5,-1687.14 2195.31,-1693.02 2197.06,-1686.24"/>
</g>
<!-- send_kv_1_0 -->
<g id="node36" class="node">
<title>send_kv_1_0</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="2333" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="2333" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU2</text>
<text text-anchor="middle" x="2333" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="2333" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- split_qkv_1&#45;&gt;send_kv_1_0 -->
<g id="edge40" class="edge">
<title>split_qkv_1&#45;&gt;send_kv_1_0</title>
<path fill="none" stroke="black" d="M2487.92,-1727.48C2460.93,-1714.7 2432.67,-1701.32 2407.79,-1689.53"/>
<polygon fill="black" stroke="black" points="2408.96,-1686.22 2398.42,-1685.1 2405.96,-1692.54 2408.96,-1686.22"/>
</g>
<!-- send_kv_1_1 -->
<g id="node40" class="node">
<title>send_kv_1_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="2598" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="2598" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU2</text>
<text text-anchor="middle" x="2598" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="2598" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- split_qkv_1&#45;&gt;send_kv_1_1 -->
<g id="edge43" class="edge">
<title>split_qkv_1&#45;&gt;send_kv_1_1</title>
<path fill="none" stroke="black" d="M2598,-1727.48C2598,-1718.57 2598,-1709.37 2598,-1700.63"/>
<polygon fill="black" stroke="black" points="2601.5,-1700.61 2598,-1690.61 2594.5,-1700.61 2601.5,-1700.61"/>
</g>
<!-- send_kv_1_2 -->
<g id="node44" class="node">
<title>send_kv_1_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="2863" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="2863" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU2</text>
<text text-anchor="middle" x="2863" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="2863" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- split_qkv_1&#45;&gt;send_kv_1_2 -->
<g id="edge47" class="edge">
<title>split_qkv_1&#45;&gt;send_kv_1_2</title>
<path fill="none" stroke="black" d="M2706.17,-1728.38C2733.83,-1715.29 2762.95,-1701.5 2788.49,-1689.4"/>
<polygon fill="black" stroke="black" points="2790.19,-1692.47 2797.73,-1685.03 2787.2,-1686.14 2790.19,-1692.47"/>
</g>
<!-- send_kv_1_3 -->
<g id="node48" class="node">
<title>send_kv_1_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="3128" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="3128" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU2</text>
<text text-anchor="middle" x="3128" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="3128" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- split_qkv_1&#45;&gt;send_kv_1_3 -->
<g id="edge51" class="edge">
<title>split_qkv_1&#45;&gt;send_kv_1_3</title>
<path fill="none" stroke="black" d="M2723.41,-1753.23C2801.95,-1736.29 2905.15,-1713.29 2996,-1690.6 3006.79,-1687.9 3018.05,-1684.97 3029.24,-1681.99"/>
<polygon fill="black" stroke="black" points="3030.3,-1685.33 3039.05,-1679.35 3028.48,-1678.57 3030.3,-1685.33"/>
</g>
<!-- accum_1_0 -->
<g id="node37" class="node">
<title>accum_1_0</title>
<polygon fill="lightgray" stroke="black" points="2076.5,-1567.67 1939.5,-1567.67 1939.5,-1514.67 2076.5,-1514.67 2076.5,-1567.67"/>
<text text-anchor="middle" x="2008" y="-1552.47" font-family="Times,serif" font-size="14.00">Initialize Output</text>
<text text-anchor="middle" x="2008" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2008" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- attn_stage_1_0&#45;&gt;accum_1_0 -->
<g id="edge41" class="edge">
<title>attn_stage_1_0&#45;&gt;accum_1_0</title>
<path fill="none" stroke="black" d="M2051.23,-1618.84C2043.76,-1605.59 2035.16,-1590.33 2027.61,-1576.94"/>
<polygon fill="black" stroke="black" points="2030.53,-1575 2022.57,-1568.01 2024.44,-1578.44 2030.53,-1575"/>
</g>
<!-- accum_1_1 -->
<g id="node41" class="node">
<title>accum_1_1</title>
<polygon fill="lightgray" stroke="black" points="2075,-1455.72 1907,-1455.72 1907,-1402.72 2075,-1402.72 2075,-1455.72"/>
<text text-anchor="middle" x="1991" y="-1440.52" font-family="Times,serif" font-size="14.00">Accumulate Output 1</text>
<text text-anchor="middle" x="1991" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="1991" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- accum_1_0&#45;&gt;accum_1_1 -->
<g id="edge44" class="edge">
<title>accum_1_0&#45;&gt;accum_1_1</title>
<path fill="none" stroke="black" d="M2004.06,-1514.67C2001.82,-1500.2 1998.99,-1481.87 1996.53,-1465.98"/>
<polygon fill="black" stroke="black" points="1999.97,-1465.31 1994.98,-1455.96 1993.05,-1466.38 1999.97,-1465.31"/>
</g>
<!-- attn_stage_1_1 -->
<g id="node38" class="node">
<title>attn_stage_1_1</title>
<polygon fill="orange" stroke="black" points="1921,-1575.17 1679,-1575.17 1679,-1507.17 1921,-1507.17 1921,-1575.17"/>
<text text-anchor="middle" x="1800" y="-1559.97" font-family="Times,serif" font-size="14.00">Ring Attention Stage 1</text>
<text text-anchor="middle" x="1800" y="-1544.97" font-family="Times,serif" font-size="14.00">Q1 × K0 × V0</text>
<text text-anchor="middle" x="1800" y="-1529.97" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="1800" y="-1514.97" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- attn_stage_1_1&#45;&gt;accum_1_1 -->
<g id="edge45" class="edge">
<title>attn_stage_1_1&#45;&gt;accum_1_1</title>
<path fill="none" stroke="black" d="M1857.57,-1507.03C1883,-1492.39 1912.72,-1475.28 1937.65,-1460.93"/>
<polygon fill="black" stroke="black" points="1939.68,-1463.8 1946.6,-1455.78 1936.19,-1457.73 1939.68,-1463.8"/>
</g>
<!-- recv_kv_1_1 -->
<g id="node39" class="node">
<title>recv_kv_1_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="1800" cy="-1653.12" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="1800" y="-1664.42" font-family="Times,serif" font-size="14.00">Receive K,V from GPU0</text>
<text text-anchor="middle" x="1800" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="1800" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- recv_kv_1_1&#45;&gt;attn_stage_1_1 -->
<g id="edge42" class="edge">
<title>recv_kv_1_1&#45;&gt;attn_stage_1_1</title>
<path fill="none" stroke="black" d="M1800,-1615.51C1800,-1605.87 1800,-1595.37 1800,-1585.41"/>
<polygon fill="black" stroke="black" points="1803.5,-1585.29 1800,-1575.29 1796.5,-1585.29 1803.5,-1585.29"/>
</g>
<!-- accum_1_2 -->
<g id="node45" class="node">
<title>accum_1_2</title>
<polygon fill="lightgray" stroke="black" points="2276,-1347.24 2108,-1347.24 2108,-1294.24 2276,-1294.24 2276,-1347.24"/>
<text text-anchor="middle" x="2192" y="-1332.04" font-family="Times,serif" font-size="14.00">Accumulate Output 2</text>
<text text-anchor="middle" x="2192" y="-1317.04" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2192" y="-1302.04" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- accum_1_1&#45;&gt;accum_1_2 -->
<g id="edge48" class="edge">
<title>accum_1_1&#45;&gt;accum_1_2</title>
<path fill="none" stroke="black" d="M2039.14,-1402.71C2067.77,-1387.55 2104.27,-1368.22 2134.41,-1352.25"/>
<polygon fill="black" stroke="black" points="2136.35,-1355.18 2143.55,-1347.4 2133.08,-1348.99 2136.35,-1355.18"/>
</g>
<!-- attn_stage_1_2 -->
<g id="node42" class="node">
<title>attn_stage_1_2</title>
<polygon fill="orange" stroke="black" points="2335,-1463.22 2093,-1463.22 2093,-1395.22 2335,-1395.22 2335,-1463.22"/>
<text text-anchor="middle" x="2214" y="-1448.02" font-family="Times,serif" font-size="14.00">Ring Attention Stage 2</text>
<text text-anchor="middle" x="2214" y="-1433.02" font-family="Times,serif" font-size="14.00">Q1 × K3 × V3</text>
<text text-anchor="middle" x="2214" y="-1418.02" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="2214" y="-1403.02" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- attn_stage_1_2&#45;&gt;accum_1_2 -->
<g id="edge49" class="edge">
<title>attn_stage_1_2&#45;&gt;accum_1_2</title>
<path fill="none" stroke="black" d="M2207.16,-1395.11C2204.68,-1383.09 2201.86,-1369.47 2199.34,-1357.25"/>
<polygon fill="black" stroke="black" points="2202.75,-1356.47 2197.3,-1347.38 2195.89,-1357.89 2202.75,-1356.47"/>
</g>
<!-- recv_kv_1_2 -->
<g id="node43" class="node">
<title>recv_kv_1_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="2225" cy="-1541.17" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="2225" y="-1552.47" font-family="Times,serif" font-size="14.00">Receive K,V from GPU0</text>
<text text-anchor="middle" x="2225" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="2225" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- recv_kv_1_2&#45;&gt;attn_stage_1_2 -->
<g id="edge46" class="edge">
<title>recv_kv_1_2&#45;&gt;attn_stage_1_2</title>
<path fill="none" stroke="black" d="M2221.34,-1503.56C2220.37,-1493.91 2219.32,-1483.42 2218.33,-1473.46"/>
<polygon fill="black" stroke="black" points="2221.79,-1472.94 2217.31,-1463.34 2214.83,-1473.64 2221.79,-1472.94"/>
</g>
<!-- accum_1_3 -->
<g id="node49" class="node">
<title>accum_1_3</title>
<polygon fill="lightgray" stroke="black" points="2276,-1249.74 2108,-1249.74 2108,-1196.74 2276,-1196.74 2276,-1249.74"/>
<text text-anchor="middle" x="2192" y="-1234.54" font-family="Times,serif" font-size="14.00">Accumulate Output 3</text>
<text text-anchor="middle" x="2192" y="-1219.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2192" y="-1204.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- accum_1_2&#45;&gt;accum_1_3 -->
<g id="edge52" class="edge">
<title>accum_1_2&#45;&gt;accum_1_3</title>
<path fill="none" stroke="black" d="M2192,-1294.15C2192,-1283.66 2192,-1271.33 2192,-1259.98"/>
<polygon fill="black" stroke="black" points="2195.5,-1259.9 2192,-1249.9 2188.5,-1259.9 2195.5,-1259.9"/>
</g>
<!-- attn_stage_1_3 -->
<g id="node46" class="node">
<title>attn_stage_1_3</title>
<polygon fill="orange" stroke="black" points="2559,-1354.74 2317,-1354.74 2317,-1286.74 2559,-1286.74 2559,-1354.74"/>
<text text-anchor="middle" x="2438" y="-1339.54" font-family="Times,serif" font-size="14.00">Ring Attention Stage 3</text>
<text text-anchor="middle" x="2438" y="-1324.54" font-family="Times,serif" font-size="14.00">Q1 × K2 × V2</text>
<text text-anchor="middle" x="2438" y="-1309.54" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="2438" y="-1294.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- attn_stage_1_3&#45;&gt;accum_1_3 -->
<g id="edge53" class="edge">
<title>attn_stage_1_3&#45;&gt;accum_1_3</title>
<path fill="none" stroke="black" d="M2352.65,-1286.61C2324.85,-1275.81 2294.2,-1263.91 2267.19,-1253.43"/>
<polygon fill="black" stroke="black" points="2268.39,-1250.14 2257.8,-1249.79 2265.86,-1256.67 2268.39,-1250.14"/>
</g>
<!-- recv_kv_1_3 -->
<g id="node47" class="node">
<title>recv_kv_1_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="2484" cy="-1429.22" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="2484" y="-1440.52" font-family="Times,serif" font-size="14.00">Receive K,V from GPU0</text>
<text text-anchor="middle" x="2484" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="2484" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- recv_kv_1_3&#45;&gt;attn_stage_1_3 -->
<g id="edge50" class="edge">
<title>recv_kv_1_3&#45;&gt;attn_stage_1_3</title>
<path fill="none" stroke="black" d="M2468.3,-1391.87C2464.47,-1383.02 2460.35,-1373.47 2456.41,-1364.35"/>
<polygon fill="black" stroke="black" points="2459.57,-1362.85 2452.39,-1355.06 2453.15,-1365.63 2459.57,-1362.85"/>
</g>
<!-- output_proj_1 -->
<g id="node50" class="node">
<title>output_proj_1</title>
<polygon fill="lightblue" stroke="black" points="2324,-1159.74 2040,-1159.74 2040,-1106.74 2324,-1106.74 2324,-1159.74"/>
<text text-anchor="middle" x="2182" y="-1144.54" font-family="Times,serif" font-size="14.00">Output Projection</text>
<text text-anchor="middle" x="2182" y="-1129.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="2182" y="-1114.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- accum_1_3&#45;&gt;output_proj_1 -->
<g id="edge54" class="edge">
<title>accum_1_3&#45;&gt;output_proj_1</title>
<path fill="none" stroke="black" d="M2189.05,-1196.31C2188.12,-1188.08 2187.07,-1178.82 2186.07,-1170.02"/>
<polygon fill="black" stroke="black" points="2189.53,-1169.52 2184.93,-1159.98 2182.58,-1170.31 2189.53,-1169.52"/>
</g>
<!-- output_proj_1&#45;&gt;residual_1 -->
<g id="edge56" class="edge">
<title>output_proj_1&#45;&gt;residual_1</title>
<path fill="none" stroke="black" d="M2176.11,-1106.31C2174.24,-1098.08 2172.13,-1088.82 2170.13,-1080.02"/>
<polygon fill="black" stroke="black" points="2173.48,-1078.96 2167.85,-1069.98 2166.65,-1080.51 2173.48,-1078.96"/>
</g>
<!-- ln1_1 -->
<g id="node52" class="node">
<title>ln1_1</title>
<polygon fill="lightyellow" stroke="black" points="2230.5,-979.74 2093.5,-979.74 2093.5,-926.74 2230.5,-926.74 2230.5,-979.74"/>
<text text-anchor="middle" x="2162" y="-964.54" font-family="Times,serif" font-size="14.00">Layer Norm 1</text>
<text text-anchor="middle" x="2162" y="-949.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2162" y="-934.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- residual_1&#45;&gt;ln1_1 -->
<g id="edge57" class="edge">
<title>residual_1&#45;&gt;ln1_1</title>
<path fill="none" stroke="black" d="M2162,-1016.31C2162,-1008.08 2162,-998.82 2162,-990.02"/>
<polygon fill="black" stroke="black" points="2165.5,-989.98 2162,-979.98 2158.5,-989.98 2165.5,-989.98"/>
</g>
<!-- gate_1 -->
<g id="node53" class="node">
<title>gate_1</title>
<polygon fill="purple" stroke="black" points="2380.5,-889.74 2147.5,-889.74 2147.5,-836.74 2380.5,-836.74 2380.5,-889.74"/>
<text text-anchor="middle" x="2264" y="-874.54" font-family="Times,serif" font-size="14.00">MoE Gate</text>
<text text-anchor="middle" x="2264" y="-859.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 8)</text>
<text text-anchor="middle" x="2264" y="-844.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- ln1_1&#45;&gt;gate_1 -->
<g id="edge58" class="edge">
<title>ln1_1&#45;&gt;gate_1</title>
<path fill="none" stroke="black" d="M2191.78,-926.55C2202.67,-917.15 2215.14,-906.4 2226.61,-896.5"/>
<polygon fill="black" stroke="black" points="2229.08,-898.99 2234.36,-889.81 2224.5,-893.69 2229.08,-898.99"/>
</g>
<!-- expert_1_0 -->
<g id="node54" class="node">
<title>expert_1_0</title>
<polygon fill="lightcoral" stroke="black" points="2365,-789.74 1873,-789.74 1873,-736.74 2365,-736.74 2365,-789.74"/>
<text text-anchor="middle" x="2119" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 0</text>
<text text-anchor="middle" x="2119" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="2119" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- ln1_1&#45;&gt;expert_1_0 -->
<g id="edge60" class="edge">
<title>ln1_1&#45;&gt;expert_1_0</title>
<path fill="none" stroke="black" d="M2151.22,-926.45C2146.91,-915.32 2142.21,-902.05 2139,-889.74 2131.25,-860.04 2126.01,-825.56 2122.85,-800.26"/>
<polygon fill="black" stroke="black" points="2126.29,-799.53 2121.62,-790.02 2119.34,-800.37 2126.29,-799.53"/>
</g>
<!-- expert_1_1 -->
<g id="node55" class="node">
<title>expert_1_1</title>
<polygon fill="lightcoral" stroke="black" points="2875,-789.74 2383,-789.74 2383,-736.74 2875,-736.74 2875,-789.74"/>
<text text-anchor="middle" x="2629" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 1</text>
<text text-anchor="middle" x="2629" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="2629" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- ln1_1&#45;&gt;expert_1_1 -->
<g id="edge62" class="edge">
<title>ln1_1&#45;&gt;expert_1_1</title>
<path fill="none" stroke="black" d="M2230.59,-937.53C2276.52,-926.69 2337.88,-910.29 2390,-889.74 2457.58,-863.1 2530.95,-822.7 2578.32,-794.98"/>
<polygon fill="black" stroke="black" points="2580.3,-797.88 2587.14,-789.79 2576.75,-791.84 2580.3,-797.88"/>
</g>
<!-- residual2_1 -->
<g id="node58" class="node">
<title>residual2_1</title>
<polygon fill="pink" stroke="black" points="2220.5,-436.74 2083.5,-436.74 2083.5,-383.74 2220.5,-383.74 2220.5,-436.74"/>
<text text-anchor="middle" x="2152" y="-421.54" font-family="Times,serif" font-size="14.00">Residual Add 2</text>
<text text-anchor="middle" x="2152" y="-406.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2152" y="-391.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- ln1_1&#45;&gt;residual2_1 -->
<g id="edge66" class="edge">
<title>ln1_1&#45;&gt;residual2_1</title>
<path fill="none" stroke="black" d="M2093.22,-947.02C1999.98,-938.02 1845,-915.36 1845,-864.24 1845,-864.24 1845,-864.24 1845,-499.24 1845,-451.74 1982.5,-428.41 2073.46,-418.16"/>
<polygon fill="black" stroke="black" points="2073.93,-421.64 2083.49,-417.07 2073.16,-414.68 2073.93,-421.64"/>
</g>
<!-- gate_1&#45;&gt;expert_1_0 -->
<g id="edge59" class="edge">
<title>gate_1&#45;&gt;expert_1_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M2225.9,-836.49C2207.34,-823.94 2184.85,-808.75 2165.31,-795.54"/>
<polygon fill="black" stroke="black" points="2167.09,-792.52 2156.84,-789.82 2163.17,-798.32 2167.09,-792.52"/>
<text text-anchor="middle" x="2227" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- gate_1&#45;&gt;expert_1_1 -->
<g id="edge61" class="edge">
<title>gate_1&#45;&gt;expert_1_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M2359.42,-836.62C2409.92,-823.06 2472.05,-806.38 2523.92,-792.45"/>
<polygon fill="black" stroke="black" points="2525.07,-795.77 2533.82,-789.8 2523.25,-789.01 2525.07,-795.77"/>
<text text-anchor="middle" x="2489" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- expert_agg_1 -->
<g id="node56" class="node">
<title>expert_agg_1</title>
<polygon fill="yellow" stroke="black" points="2315.61,-699.74 2055.34,-699.74 1988.39,-563.74 2248.66,-563.74 2315.61,-699.74"/>
<text text-anchor="middle" x="2152" y="-650.54" font-family="Times,serif" font-size="14.00">Expert Aggregation</text>
<text text-anchor="middle" x="2152" y="-635.54" font-family="Times,serif" font-size="14.00">Combine 2 experts</text>
<text text-anchor="middle" x="2152" y="-620.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2152" y="-605.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- expert_1_0&#45;&gt;expert_agg_1 -->
<g id="edge63" class="edge">
<title>expert_1_0&#45;&gt;expert_agg_1</title>
<path fill="none" stroke="black" d="M2125.52,-736.66C2127.56,-728.64 2129.93,-719.34 2132.4,-709.66"/>
<polygon fill="black" stroke="black" points="2135.81,-710.45 2134.89,-699.9 2129.03,-708.72 2135.81,-710.45"/>
</g>
<!-- expert_1_1&#45;&gt;expert_agg_1 -->
<g id="edge64" class="edge">
<title>expert_1_1&#45;&gt;expert_agg_1</title>
<path fill="none" stroke="black" d="M2535.04,-736.73C2471.8,-719.56 2386.77,-696.48 2312.89,-676.42"/>
<polygon fill="black" stroke="black" points="2313.58,-672.98 2303.01,-673.74 2311.75,-679.74 2313.58,-672.98"/>
</g>
<!-- moe_output_1 -->
<g id="node57" class="node">
<title>moe_output_1</title>
<polygon fill="lightblue" stroke="black" points="2294,-526.74 2010,-526.74 2010,-473.74 2294,-473.74 2294,-526.74"/>
<text text-anchor="middle" x="2152" y="-511.54" font-family="Times,serif" font-size="14.00">MoE Output Projection</text>
<text text-anchor="middle" x="2152" y="-496.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="2152" y="-481.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- expert_agg_1&#45;&gt;moe_output_1 -->
<g id="edge65" class="edge">
<title>expert_agg_1&#45;&gt;moe_output_1</title>
<path fill="none" stroke="black" d="M2152,-563.71C2152,-554.51 2152,-545.38 2152,-537.04"/>
<polygon fill="black" stroke="black" points="2155.5,-536.98 2152,-526.98 2148.5,-536.98 2155.5,-536.98"/>
</g>
<!-- moe_output_1&#45;&gt;residual2_1 -->
<g id="edge67" class="edge">
<title>moe_output_1&#45;&gt;residual2_1</title>
<path fill="none" stroke="black" d="M2152,-473.31C2152,-465.08 2152,-455.82 2152,-447.02"/>
<polygon fill="black" stroke="black" points="2155.5,-446.98 2152,-436.98 2148.5,-446.98 2155.5,-446.98"/>
</g>
<!-- ln2_1 -->
<g id="node59" class="node">
<title>ln2_1</title>
<polygon fill="lightyellow" stroke="black" points="2259.5,-346.74 2122.5,-346.74 2122.5,-293.74 2259.5,-293.74 2259.5,-346.74"/>
<text text-anchor="middle" x="2191" y="-331.54" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="2191" y="-316.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2191" y="-301.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- residual2_1&#45;&gt;ln2_1 -->
<g id="edge68" class="edge">
<title>residual2_1&#45;&gt;ln2_1</title>
<path fill="none" stroke="black" d="M2163.49,-383.31C2167.26,-374.81 2171.51,-365.22 2175.53,-356.16"/>
<polygon fill="black" stroke="black" points="2178.74,-357.54 2179.59,-346.98 2172.34,-354.71 2178.74,-357.54"/>
</g>
<!-- output_seg_1 -->
<g id="node60" class="node">
<title>output_seg_1</title>
<polygon fill="lightcyan" stroke="black" points="2345.5,-256.74 2196.5,-256.74 2196.5,-203.74 2345.5,-203.74 2345.5,-256.74"/>
<text text-anchor="middle" x="2271" y="-241.54" font-family="Times,serif" font-size="14.00">Output Segment 1</text>
<text text-anchor="middle" x="2271" y="-226.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2271" y="-211.54" font-family="Times,serif" font-size="14.00">GPU_1</text>
</g>
<!-- ln2_1&#45;&gt;output_seg_1 -->
<g id="edge69" class="edge">
<title>ln2_1&#45;&gt;output_seg_1</title>
<path fill="none" stroke="black" d="M2214.57,-293.31C2222.79,-284.27 2232.13,-274 2240.81,-264.45"/>
<polygon fill="black" stroke="black" points="2243.46,-266.74 2247.6,-256.98 2238.28,-262.03 2243.46,-266.74"/>
</g>
<!-- output_seg_1&#45;&gt;gather -->
<g id="edge139" class="edge">
<title>output_seg_1&#45;&gt;gather</title>
<path fill="none" stroke="black" d="M2303.71,-203.62C2315.51,-194.37 2329.19,-183.65 2342.41,-173.29"/>
<polygon fill="black" stroke="black" points="2344.85,-175.83 2350.56,-166.91 2340.53,-170.32 2344.85,-175.83"/>
</g>
<!-- qkv_proj_2 -->
<g id="node62" class="node">
<title>qkv_proj_2</title>
<polygon fill="lightblue" stroke="black" points="3930.5,-1923.6 3631.5,-1923.6 3631.5,-1870.6 3930.5,-1870.6 3930.5,-1923.6"/>
<text text-anchor="middle" x="3781" y="-1908.4" font-family="Times,serif" font-size="14.00">QKV Projection</text>
<text text-anchor="middle" x="3781" y="-1893.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 3*d_model)</text>
<text text-anchor="middle" x="3781" y="-1878.4" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- input_2&#45;&gt;qkv_proj_2 -->
<g id="edge71" class="edge">
<title>input_2&#45;&gt;qkv_proj_2</title>
<path fill="none" stroke="black" d="M3348.61,-1974.05C3419.59,-1961.58 3532.83,-1941.69 3625.63,-1925.39"/>
<polygon fill="black" stroke="black" points="3626.44,-1928.8 3635.69,-1923.62 3625.23,-1921.91 3626.44,-1928.8"/>
</g>
<!-- residual_2 -->
<g id="node80" class="node">
<title>residual_2</title>
<polygon fill="pink" stroke="black" points="3353.5,-1069.74 3216.5,-1069.74 3216.5,-1016.74 3353.5,-1016.74 3353.5,-1069.74"/>
<text text-anchor="middle" x="3285" y="-1054.54" font-family="Times,serif" font-size="14.00">Residual Add</text>
<text text-anchor="middle" x="3285" y="-1039.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3285" y="-1024.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- input_2&#45;&gt;residual_2 -->
<g id="edge89" class="edge">
<title>input_2&#45;&gt;residual_2</title>
<path fill="none" stroke="black" d="M3280,-1960.3C3280,-1942.76 3280,-1919.03 3280,-1898.1 3280,-1898.1 3280,-1898.1 3280,-1132.24 3280,-1115.04 3280.96,-1095.99 3282.04,-1080.02"/>
<polygon fill="black" stroke="black" points="3285.54,-1080.24 3282.76,-1070.02 3278.56,-1079.74 3285.54,-1080.24"/>
</g>
<!-- split_qkv_2 -->
<g id="node63" class="node">
<title>split_qkv_2</title>
<polygon fill="yellow" stroke="black" points="4286.36,-1833.6 3997.85,-1833.6 3923.64,-1727.6 4212.15,-1727.6 4286.36,-1833.6"/>
<text text-anchor="middle" x="4105" y="-1791.9" font-family="Times,serif" font-size="14.00">Split QKV</text>
<text text-anchor="middle" x="4105" y="-1776.9" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="4105" y="-1761.9" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- qkv_proj_2&#45;&gt;split_qkv_2 -->
<g id="edge72" class="edge">
<title>qkv_proj_2&#45;&gt;split_qkv_2</title>
<path fill="none" stroke="black" d="M3853.31,-1870.55C3890.59,-1857.37 3937.12,-1840.93 3980,-1825.78"/>
<polygon fill="black" stroke="black" points="3981.4,-1828.99 3989.66,-1822.36 3979.06,-1822.39 3981.4,-1828.99"/>
</g>
<!-- attn_stage_2_0 -->
<g id="node64" class="node">
<title>attn_stage_2_0</title>
<polygon fill="orange" stroke="black" points="3830,-1687.12 3588,-1687.12 3588,-1619.12 3830,-1619.12 3830,-1687.12"/>
<text text-anchor="middle" x="3709" y="-1671.92" font-family="Times,serif" font-size="14.00">Ring Attention Stage 0</text>
<text text-anchor="middle" x="3709" y="-1656.92" font-family="Times,serif" font-size="14.00">Q2 × K2 × V2</text>
<text text-anchor="middle" x="3709" y="-1641.92" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="3709" y="-1626.92" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- split_qkv_2&#45;&gt;attn_stage_2_0 -->
<g id="edge73" class="edge">
<title>split_qkv_2&#45;&gt;attn_stage_2_0</title>
<path fill="none" stroke="black" d="M3940.79,-1727.57C3901.16,-1715.01 3859.68,-1701.87 3822.93,-1690.22"/>
<polygon fill="black" stroke="black" points="3823.79,-1686.83 3813.2,-1687.14 3821.68,-1693.5 3823.79,-1686.83"/>
</g>
<!-- send_kv_2_0 -->
<g id="node65" class="node">
<title>send_kv_2_0</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="4767" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="4767" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU3</text>
<text text-anchor="middle" x="4767" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="4767" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- split_qkv_2&#45;&gt;send_kv_2_0 -->
<g id="edge74" class="edge">
<title>split_qkv_2&#45;&gt;send_kv_2_0</title>
<path fill="none" stroke="black" d="M4235.87,-1761.47C4343.58,-1745.63 4499.95,-1720.51 4635,-1690.6 4646.24,-1688.11 4657.96,-1685.26 4669.56,-1682.26"/>
<polygon fill="black" stroke="black" points="4670.48,-1685.64 4679.27,-1679.73 4668.71,-1678.87 4670.48,-1685.64"/>
</g>
<!-- send_kv_2_1 -->
<g id="node69" class="node">
<title>send_kv_2_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="3972" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="3972" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU3</text>
<text text-anchor="middle" x="3972" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="3972" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- split_qkv_2&#45;&gt;send_kv_2_1 -->
<g id="edge77" class="edge">
<title>split_qkv_2&#45;&gt;send_kv_2_1</title>
<path fill="none" stroke="black" d="M4049.75,-1727.48C4038.72,-1717.07 4027.27,-1706.27 4016.66,-1696.25"/>
<polygon fill="black" stroke="black" points="4018.77,-1693.43 4009.09,-1689.12 4013.96,-1698.53 4018.77,-1693.43"/>
</g>
<!-- send_kv_2_2 -->
<g id="node73" class="node">
<title>send_kv_2_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="4237" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="4237" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU3</text>
<text text-anchor="middle" x="4237" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="4237" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- split_qkv_2&#45;&gt;send_kv_2_2 -->
<g id="edge81" class="edge">
<title>split_qkv_2&#45;&gt;send_kv_2_2</title>
<path fill="none" stroke="black" d="M4159.83,-1727.48C4170.78,-1717.07 4182.14,-1706.27 4192.68,-1696.25"/>
<polygon fill="black" stroke="black" points="4195.35,-1698.54 4200.19,-1689.12 4190.53,-1693.47 4195.35,-1698.54"/>
</g>
<!-- send_kv_2_3 -->
<g id="node77" class="node">
<title>send_kv_2_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="4502" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="4502" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU3</text>
<text text-anchor="middle" x="4502" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="4502" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- split_qkv_2&#45;&gt;send_kv_2_3 -->
<g id="edge85" class="edge">
<title>split_qkv_2&#45;&gt;send_kv_2_3</title>
<path fill="none" stroke="black" d="M4222.77,-1742.38C4281.97,-1723.67 4352.71,-1701.31 4408.18,-1683.78"/>
<polygon fill="black" stroke="black" points="4409.52,-1687.02 4418,-1680.67 4407.41,-1680.35 4409.52,-1687.02"/>
</g>
<!-- accum_2_0 -->
<g id="node66" class="node">
<title>accum_2_0</title>
<polygon fill="lightgray" stroke="black" points="3715.5,-1567.67 3578.5,-1567.67 3578.5,-1514.67 3715.5,-1514.67 3715.5,-1567.67"/>
<text text-anchor="middle" x="3647" y="-1552.47" font-family="Times,serif" font-size="14.00">Initialize Output</text>
<text text-anchor="middle" x="3647" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3647" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- attn_stage_2_0&#45;&gt;accum_2_0 -->
<g id="edge75" class="edge">
<title>attn_stage_2_0&#45;&gt;accum_2_0</title>
<path fill="none" stroke="black" d="M3690.23,-1618.84C3682.76,-1605.59 3674.16,-1590.33 3666.61,-1576.94"/>
<polygon fill="black" stroke="black" points="3669.53,-1575 3661.57,-1568.01 3663.44,-1578.44 3669.53,-1575"/>
</g>
<!-- accum_2_1 -->
<g id="node70" class="node">
<title>accum_2_1</title>
<polygon fill="lightgray" stroke="black" points="3624,-1455.72 3456,-1455.72 3456,-1402.72 3624,-1402.72 3624,-1455.72"/>
<text text-anchor="middle" x="3540" y="-1440.52" font-family="Times,serif" font-size="14.00">Accumulate Output 1</text>
<text text-anchor="middle" x="3540" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3540" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- accum_2_0&#45;&gt;accum_2_1 -->
<g id="edge78" class="edge">
<title>accum_2_0&#45;&gt;accum_2_1</title>
<path fill="none" stroke="black" d="M3622.18,-1514.67C3607.3,-1499.37 3588.21,-1479.76 3572.18,-1463.28"/>
<polygon fill="black" stroke="black" points="3574.54,-1460.69 3565.05,-1455.96 3569.52,-1465.57 3574.54,-1460.69"/>
</g>
<!-- attn_stage_2_1 -->
<g id="node67" class="node">
<title>attn_stage_2_1</title>
<polygon fill="orange" stroke="black" points="3560,-1575.17 3318,-1575.17 3318,-1507.17 3560,-1507.17 3560,-1575.17"/>
<text text-anchor="middle" x="3439" y="-1559.97" font-family="Times,serif" font-size="14.00">Ring Attention Stage 1</text>
<text text-anchor="middle" x="3439" y="-1544.97" font-family="Times,serif" font-size="14.00">Q2 × K1 × V1</text>
<text text-anchor="middle" x="3439" y="-1529.97" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="3439" y="-1514.97" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- attn_stage_2_1&#45;&gt;accum_2_1 -->
<g id="edge79" class="edge">
<title>attn_stage_2_1&#45;&gt;accum_2_1</title>
<path fill="none" stroke="black" d="M3469.58,-1506.88C3482.22,-1493.12 3496.84,-1477.2 3509.47,-1463.45"/>
<polygon fill="black" stroke="black" points="3512.07,-1465.79 3516.26,-1456.06 3506.92,-1461.06 3512.07,-1465.79"/>
</g>
<!-- recv_kv_2_1 -->
<g id="node68" class="node">
<title>recv_kv_2_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="3439" cy="-1653.12" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="3439" y="-1664.42" font-family="Times,serif" font-size="14.00">Receive K,V from GPU1</text>
<text text-anchor="middle" x="3439" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="3439" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- recv_kv_2_1&#45;&gt;attn_stage_2_1 -->
<g id="edge76" class="edge">
<title>recv_kv_2_1&#45;&gt;attn_stage_2_1</title>
<path fill="none" stroke="black" d="M3439,-1615.51C3439,-1605.87 3439,-1595.37 3439,-1585.41"/>
<polygon fill="black" stroke="black" points="3442.5,-1585.29 3439,-1575.29 3435.5,-1585.29 3442.5,-1585.29"/>
</g>
<!-- accum_2_2 -->
<g id="node74" class="node">
<title>accum_2_2</title>
<polygon fill="lightgray" stroke="black" points="3814,-1347.24 3646,-1347.24 3646,-1294.24 3814,-1294.24 3814,-1347.24"/>
<text text-anchor="middle" x="3730" y="-1332.04" font-family="Times,serif" font-size="14.00">Accumulate Output 2</text>
<text text-anchor="middle" x="3730" y="-1317.04" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3730" y="-1302.04" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- accum_2_1&#45;&gt;accum_2_2 -->
<g id="edge82" class="edge">
<title>accum_2_1&#45;&gt;accum_2_2</title>
<path fill="none" stroke="black" d="M3585.51,-1402.71C3612.46,-1387.61 3646.77,-1368.38 3675.2,-1352.45"/>
<polygon fill="black" stroke="black" points="3677.19,-1355.35 3684.2,-1347.4 3673.77,-1349.24 3677.19,-1355.35"/>
</g>
<!-- attn_stage_2_2 -->
<g id="node71" class="node">
<title>attn_stage_2_2</title>
<polygon fill="orange" stroke="black" points="3884,-1463.22 3642,-1463.22 3642,-1395.22 3884,-1395.22 3884,-1463.22"/>
<text text-anchor="middle" x="3763" y="-1448.02" font-family="Times,serif" font-size="14.00">Ring Attention Stage 2</text>
<text text-anchor="middle" x="3763" y="-1433.02" font-family="Times,serif" font-size="14.00">Q2 × K0 × V0</text>
<text text-anchor="middle" x="3763" y="-1418.02" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="3763" y="-1403.02" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- attn_stage_2_2&#45;&gt;accum_2_2 -->
<g id="edge83" class="edge">
<title>attn_stage_2_2&#45;&gt;accum_2_2</title>
<path fill="none" stroke="black" d="M3752.74,-1395.11C3749.01,-1383.09 3744.79,-1369.47 3741.01,-1357.25"/>
<polygon fill="black" stroke="black" points="3744.25,-1355.9 3737.95,-1347.38 3737.56,-1357.97 3744.25,-1355.9"/>
</g>
<!-- recv_kv_2_2 -->
<g id="node72" class="node">
<title>recv_kv_2_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="3864" cy="-1541.17" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="3864" y="-1552.47" font-family="Times,serif" font-size="14.00">Receive K,V from GPU1</text>
<text text-anchor="middle" x="3864" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="3864" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- recv_kv_2_2&#45;&gt;attn_stage_2_2 -->
<g id="edge80" class="edge">
<title>recv_kv_2_2&#45;&gt;attn_stage_2_2</title>
<path fill="none" stroke="black" d="M3831.49,-1504.77C3821.55,-1493.96 3810.55,-1481.98 3800.33,-1470.85"/>
<polygon fill="black" stroke="black" points="3802.74,-1468.3 3793.39,-1463.3 3797.58,-1473.04 3802.74,-1468.3"/>
</g>
<!-- accum_2_3 -->
<g id="node78" class="node">
<title>accum_2_3</title>
<polygon fill="lightgray" stroke="black" points="3814,-1249.74 3646,-1249.74 3646,-1196.74 3814,-1196.74 3814,-1249.74"/>
<text text-anchor="middle" x="3730" y="-1234.54" font-family="Times,serif" font-size="14.00">Accumulate Output 3</text>
<text text-anchor="middle" x="3730" y="-1219.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3730" y="-1204.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- accum_2_2&#45;&gt;accum_2_3 -->
<g id="edge86" class="edge">
<title>accum_2_2&#45;&gt;accum_2_3</title>
<path fill="none" stroke="black" d="M3730,-1294.15C3730,-1283.66 3730,-1271.33 3730,-1259.98"/>
<polygon fill="black" stroke="black" points="3733.5,-1259.9 3730,-1249.9 3726.5,-1259.9 3733.5,-1259.9"/>
</g>
<!-- attn_stage_2_3 -->
<g id="node75" class="node">
<title>attn_stage_2_3</title>
<polygon fill="orange" stroke="black" points="4097,-1354.74 3855,-1354.74 3855,-1286.74 4097,-1286.74 4097,-1354.74"/>
<text text-anchor="middle" x="3976" y="-1339.54" font-family="Times,serif" font-size="14.00">Ring Attention Stage 3</text>
<text text-anchor="middle" x="3976" y="-1324.54" font-family="Times,serif" font-size="14.00">Q2 × K3 × V3</text>
<text text-anchor="middle" x="3976" y="-1309.54" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="3976" y="-1294.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- attn_stage_2_3&#45;&gt;accum_2_3 -->
<g id="edge87" class="edge">
<title>attn_stage_2_3&#45;&gt;accum_2_3</title>
<path fill="none" stroke="black" d="M3890.65,-1286.61C3862.85,-1275.81 3832.2,-1263.91 3805.19,-1253.43"/>
<polygon fill="black" stroke="black" points="3806.39,-1250.14 3795.8,-1249.79 3803.86,-1256.67 3806.39,-1250.14"/>
</g>
<!-- recv_kv_2_3 -->
<g id="node76" class="node">
<title>recv_kv_2_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="4033" cy="-1429.22" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="4033" y="-1440.52" font-family="Times,serif" font-size="14.00">Receive K,V from GPU1</text>
<text text-anchor="middle" x="4033" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="4033" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- recv_kv_2_3&#45;&gt;attn_stage_2_3 -->
<g id="edge84" class="edge">
<title>recv_kv_2_3&#45;&gt;attn_stage_2_3</title>
<path fill="none" stroke="black" d="M4013.54,-1391.87C4008.75,-1382.92 4003.58,-1373.27 3998.66,-1364.07"/>
<polygon fill="black" stroke="black" points="4001.64,-1362.22 3993.84,-1355.06 3995.47,-1365.53 4001.64,-1362.22"/>
</g>
<!-- output_proj_2 -->
<g id="node79" class="node">
<title>output_proj_2</title>
<polygon fill="lightblue" stroke="black" points="3738,-1159.74 3454,-1159.74 3454,-1106.74 3738,-1106.74 3738,-1159.74"/>
<text text-anchor="middle" x="3596" y="-1144.54" font-family="Times,serif" font-size="14.00">Output Projection</text>
<text text-anchor="middle" x="3596" y="-1129.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="3596" y="-1114.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- accum_2_3&#45;&gt;output_proj_2 -->
<g id="edge88" class="edge">
<title>accum_2_3&#45;&gt;output_proj_2</title>
<path fill="none" stroke="black" d="M3690.88,-1196.55C3676.02,-1186.79 3658.93,-1175.57 3643.39,-1165.36"/>
<polygon fill="black" stroke="black" points="3645.22,-1162.37 3634.94,-1159.81 3641.37,-1168.22 3645.22,-1162.37"/>
</g>
<!-- output_proj_2&#45;&gt;residual_2 -->
<g id="edge90" class="edge">
<title>output_proj_2&#45;&gt;residual_2</title>
<path fill="none" stroke="black" d="M3505.63,-1106.67C3460.61,-1093.93 3406.7,-1078.68 3363.44,-1066.44"/>
<polygon fill="black" stroke="black" points="3364.4,-1063.07 3353.82,-1063.71 3362.49,-1069.8 3364.4,-1063.07"/>
</g>
<!-- ln1_2 -->
<g id="node81" class="node">
<title>ln1_2</title>
<polygon fill="lightyellow" stroke="black" points="3353.5,-979.74 3216.5,-979.74 3216.5,-926.74 3353.5,-926.74 3353.5,-979.74"/>
<text text-anchor="middle" x="3285" y="-964.54" font-family="Times,serif" font-size="14.00">Layer Norm 1</text>
<text text-anchor="middle" x="3285" y="-949.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3285" y="-934.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- residual_2&#45;&gt;ln1_2 -->
<g id="edge91" class="edge">
<title>residual_2&#45;&gt;ln1_2</title>
<path fill="none" stroke="black" d="M3285,-1016.31C3285,-1008.08 3285,-998.82 3285,-990.02"/>
<polygon fill="black" stroke="black" points="3288.5,-989.98 3285,-979.98 3281.5,-989.98 3288.5,-989.98"/>
</g>
<!-- gate_2 -->
<g id="node82" class="node">
<title>gate_2</title>
<polygon fill="purple" stroke="black" points="3438.5,-889.74 3205.5,-889.74 3205.5,-836.74 3438.5,-836.74 3438.5,-889.74"/>
<text text-anchor="middle" x="3322" y="-874.54" font-family="Times,serif" font-size="14.00">MoE Gate</text>
<text text-anchor="middle" x="3322" y="-859.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 8)</text>
<text text-anchor="middle" x="3322" y="-844.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- ln1_2&#45;&gt;gate_2 -->
<g id="edge92" class="edge">
<title>ln1_2&#45;&gt;gate_2</title>
<path fill="none" stroke="black" d="M3295.9,-926.31C3299.44,-917.9 3303.43,-908.42 3307.2,-899.44"/>
<polygon fill="black" stroke="black" points="3310.53,-900.56 3311.18,-889.98 3304.07,-897.84 3310.53,-900.56"/>
</g>
<!-- expert_2_0 -->
<g id="node83" class="node">
<title>expert_2_0</title>
<polygon fill="lightcoral" stroke="black" points="3423,-789.74 2931,-789.74 2931,-736.74 3423,-736.74 3423,-789.74"/>
<text text-anchor="middle" x="3177" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 0</text>
<text text-anchor="middle" x="3177" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="3177" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- ln1_2&#45;&gt;expert_2_0 -->
<g id="edge94" class="edge">
<title>ln1_2&#45;&gt;expert_2_0</title>
<path fill="none" stroke="black" d="M3234.58,-926.5C3220.32,-916.84 3206.19,-904.55 3197,-889.74 3180.25,-862.77 3176.01,-826.46 3175.51,-799.84"/>
<polygon fill="black" stroke="black" points="3179.01,-799.79 3175.49,-789.8 3172.01,-799.81 3179.01,-799.79"/>
</g>
<!-- expert_2_1 -->
<g id="node84" class="node">
<title>expert_2_1</title>
<polygon fill="lightcoral" stroke="black" points="3933,-789.74 3441,-789.74 3441,-736.74 3933,-736.74 3933,-789.74"/>
<text text-anchor="middle" x="3687" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 1</text>
<text text-anchor="middle" x="3687" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="3687" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- ln1_2&#45;&gt;expert_2_1 -->
<g id="edge96" class="edge">
<title>ln1_2&#45;&gt;expert_2_1</title>
<path fill="none" stroke="black" d="M3353.54,-928C3382.95,-917.08 3417.49,-903.54 3448,-889.74 3512.99,-860.34 3585.17,-821.54 3633.03,-794.91"/>
<polygon fill="black" stroke="black" points="3634.95,-797.85 3641.97,-789.92 3631.54,-791.74 3634.95,-797.85"/>
</g>
<!-- residual2_2 -->
<g id="node87" class="node">
<title>residual2_2</title>
<polygon fill="pink" stroke="black" points="2971.5,-436.74 2834.5,-436.74 2834.5,-383.74 2971.5,-383.74 2971.5,-436.74"/>
<text text-anchor="middle" x="2903" y="-421.54" font-family="Times,serif" font-size="14.00">Residual Add 2</text>
<text text-anchor="middle" x="2903" y="-406.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2903" y="-391.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- ln1_2&#45;&gt;residual2_2 -->
<g id="edge100" class="edge">
<title>ln1_2&#45;&gt;residual2_2</title>
<path fill="none" stroke="black" d="M3216.26,-950.36C3106.28,-945.45 2903,-927.79 2903,-864.24 2903,-864.24 2903,-864.24 2903,-499.24 2903,-482.07 2903,-463.02 2903,-447.04"/>
<polygon fill="black" stroke="black" points="2906.5,-447.04 2903,-437.04 2899.5,-447.04 2906.5,-447.04"/>
</g>
<!-- gate_2&#45;&gt;expert_2_0 -->
<g id="edge93" class="edge">
<title>gate_2&#45;&gt;expert_2_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M3283.9,-836.49C3265.34,-823.94 3242.85,-808.75 3223.31,-795.54"/>
<polygon fill="black" stroke="black" points="3225.09,-792.52 3214.84,-789.82 3221.17,-798.32 3225.09,-792.52"/>
<text text-anchor="middle" x="3285" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- gate_2&#45;&gt;expert_2_1 -->
<g id="edge95" class="edge">
<title>gate_2&#45;&gt;expert_2_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M3400.95,-836.61C3431.45,-827.06 3466.71,-816.43 3499,-807.74 3518.97,-802.36 3540.24,-797.05 3561.02,-792.08"/>
<polygon fill="black" stroke="black" points="3561.92,-795.47 3570.85,-789.75 3560.31,-788.65 3561.92,-795.47"/>
<text text-anchor="middle" x="3531" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- expert_agg_2 -->
<g id="node85" class="node">
<title>expert_agg_2</title>
<polygon fill="yellow" stroke="black" points="3340.61,-699.74 3080.34,-699.74 3013.39,-563.74 3273.66,-563.74 3340.61,-699.74"/>
<text text-anchor="middle" x="3177" y="-650.54" font-family="Times,serif" font-size="14.00">Expert Aggregation</text>
<text text-anchor="middle" x="3177" y="-635.54" font-family="Times,serif" font-size="14.00">Combine 2 experts</text>
<text text-anchor="middle" x="3177" y="-620.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3177" y="-605.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- expert_2_0&#45;&gt;expert_agg_2 -->
<g id="edge97" class="edge">
<title>expert_2_0&#45;&gt;expert_agg_2</title>
<path fill="none" stroke="black" d="M3177,-736.66C3177,-728.72 3177,-719.53 3177,-709.97"/>
<polygon fill="black" stroke="black" points="3180.5,-709.9 3177,-699.9 3173.5,-709.9 3180.5,-709.9"/>
</g>
<!-- expert_2_1&#45;&gt;expert_agg_2 -->
<g id="edge98" class="edge">
<title>expert_2_1&#45;&gt;expert_agg_2</title>
<path fill="none" stroke="black" d="M3586.54,-736.73C3515.3,-718.64 3418.21,-693.99 3336.44,-673.23"/>
<polygon fill="black" stroke="black" points="3337.1,-669.78 3326.55,-670.71 3335.38,-676.57 3337.1,-669.78"/>
</g>
<!-- moe_output_2 -->
<g id="node86" class="node">
<title>moe_output_2</title>
<polygon fill="lightblue" stroke="black" points="3241,-526.74 2957,-526.74 2957,-473.74 3241,-473.74 3241,-526.74"/>
<text text-anchor="middle" x="3099" y="-511.54" font-family="Times,serif" font-size="14.00">MoE Output Projection</text>
<text text-anchor="middle" x="3099" y="-496.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="3099" y="-481.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- expert_agg_2&#45;&gt;moe_output_2 -->
<g id="edge99" class="edge">
<title>expert_agg_2&#45;&gt;moe_output_2</title>
<path fill="none" stroke="black" d="M3136.63,-563.71C3130.78,-554 3124.97,-544.36 3119.73,-535.66"/>
<polygon fill="black" stroke="black" points="3122.66,-533.74 3114.5,-526.98 3116.66,-537.35 3122.66,-533.74"/>
</g>
<!-- moe_output_2&#45;&gt;residual2_2 -->
<g id="edge101" class="edge">
<title>moe_output_2&#45;&gt;residual2_2</title>
<path fill="none" stroke="black" d="M3042.05,-473.67C3019.3,-463.45 2992.94,-451.62 2969.34,-441.02"/>
<polygon fill="black" stroke="black" points="2970.65,-437.78 2960.1,-436.88 2967.79,-444.16 2970.65,-437.78"/>
</g>
<!-- ln2_2 -->
<g id="node88" class="node">
<title>ln2_2</title>
<polygon fill="lightyellow" stroke="black" points="2859.5,-346.74 2722.5,-346.74 2722.5,-293.74 2859.5,-293.74 2859.5,-346.74"/>
<text text-anchor="middle" x="2791" y="-331.54" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="2791" y="-316.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2791" y="-301.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- residual2_2&#45;&gt;ln2_2 -->
<g id="edge102" class="edge">
<title>residual2_2&#45;&gt;ln2_2</title>
<path fill="none" stroke="black" d="M2870.3,-383.55C2858.23,-374.06 2844.39,-363.19 2831.69,-353.21"/>
<polygon fill="black" stroke="black" points="2833.57,-350.24 2823.54,-346.81 2829.24,-355.74 2833.57,-350.24"/>
</g>
<!-- output_seg_2 -->
<g id="node89" class="node">
<title>output_seg_2</title>
<polygon fill="lightcyan" stroke="black" points="2672.5,-256.74 2523.5,-256.74 2523.5,-203.74 2672.5,-203.74 2672.5,-256.74"/>
<text text-anchor="middle" x="2598" y="-241.54" font-family="Times,serif" font-size="14.00">Output Segment 2</text>
<text text-anchor="middle" x="2598" y="-226.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2598" y="-211.54" font-family="Times,serif" font-size="14.00">GPU_2</text>
</g>
<!-- ln2_2&#45;&gt;output_seg_2 -->
<g id="edge103" class="edge">
<title>ln2_2&#45;&gt;output_seg_2</title>
<path fill="none" stroke="black" d="M2734.92,-293.67C2712.52,-283.45 2686.57,-271.62 2663.32,-261.02"/>
<polygon fill="black" stroke="black" points="2664.77,-257.84 2654.22,-256.88 2661.87,-264.21 2664.77,-257.84"/>
</g>
<!-- output_seg_2&#45;&gt;gather -->
<g id="edge140" class="edge">
<title>output_seg_2&#45;&gt;gather</title>
<path fill="none" stroke="black" d="M2546.5,-203.62C2526.76,-193.8 2503.7,-182.33 2481.72,-171.39"/>
<polygon fill="black" stroke="black" points="2483.22,-168.23 2472.71,-166.91 2480.1,-174.5 2483.22,-168.23"/>
</g>
<!-- qkv_proj_3 -->
<g id="node91" class="node">
<title>qkv_proj_3</title>
<polygon fill="lightblue" stroke="black" points="5564.5,-1923.6 5265.5,-1923.6 5265.5,-1870.6 5564.5,-1870.6 5564.5,-1923.6"/>
<text text-anchor="middle" x="5415" y="-1908.4" font-family="Times,serif" font-size="14.00">QKV Projection</text>
<text text-anchor="middle" x="5415" y="-1893.4" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 3*d_model)</text>
<text text-anchor="middle" x="5415" y="-1878.4" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- input_3&#45;&gt;qkv_proj_3 -->
<g id="edge105" class="edge">
<title>input_3&#45;&gt;qkv_proj_3</title>
<path fill="none" stroke="black" d="M4987.71,-1973.91C5058.02,-1961.44 5169.64,-1941.63 5261.17,-1925.39"/>
<polygon fill="black" stroke="black" points="5261.86,-1928.83 5271.09,-1923.63 5260.63,-1921.93 5261.86,-1928.83"/>
</g>
<!-- residual_3 -->
<g id="node109" class="node">
<title>residual_3</title>
<polygon fill="pink" stroke="black" points="4987.5,-1069.74 4850.5,-1069.74 4850.5,-1016.74 4987.5,-1016.74 4987.5,-1069.74"/>
<text text-anchor="middle" x="4919" y="-1054.54" font-family="Times,serif" font-size="14.00">Residual Add</text>
<text text-anchor="middle" x="4919" y="-1039.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="4919" y="-1024.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- input_3&#45;&gt;residual_3 -->
<g id="edge123" class="edge">
<title>input_3&#45;&gt;residual_3</title>
<path fill="none" stroke="black" d="M4919,-1960.3C4919,-1942.76 4919,-1919.03 4919,-1898.1 4919,-1898.1 4919,-1898.1 4919,-1132.24 4919,-1115.07 4919,-1096.02 4919,-1080.04"/>
<polygon fill="black" stroke="black" points="4922.5,-1080.04 4919,-1070.04 4915.5,-1080.04 4922.5,-1080.04"/>
</g>
<!-- split_qkv_3 -->
<g id="node92" class="node">
<title>split_qkv_3</title>
<polygon fill="yellow" stroke="black" points="5986.36,-1833.6 5697.85,-1833.6 5623.64,-1727.6 5912.15,-1727.6 5986.36,-1833.6"/>
<text text-anchor="middle" x="5805" y="-1791.9" font-family="Times,serif" font-size="14.00">Split QKV</text>
<text text-anchor="middle" x="5805" y="-1776.9" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="5805" y="-1761.9" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- qkv_proj_3&#45;&gt;split_qkv_3 -->
<g id="edge106" class="edge">
<title>qkv_proj_3&#45;&gt;split_qkv_3</title>
<path fill="none" stroke="black" d="M5502.04,-1870.55C5553.18,-1855.53 5618.8,-1836.27 5675.88,-1819.51"/>
<polygon fill="black" stroke="black" points="5677.08,-1822.8 5685.69,-1816.63 5675.11,-1816.09 5677.08,-1822.8"/>
</g>
<!-- attn_stage_3_0 -->
<g id="node93" class="node">
<title>attn_stage_3_0</title>
<polygon fill="orange" stroke="black" points="5735,-1687.12 5493,-1687.12 5493,-1619.12 5735,-1619.12 5735,-1687.12"/>
<text text-anchor="middle" x="5614" y="-1671.92" font-family="Times,serif" font-size="14.00">Ring Attention Stage 0</text>
<text text-anchor="middle" x="5614" y="-1656.92" font-family="Times,serif" font-size="14.00">Q3 × K3 × V3</text>
<text text-anchor="middle" x="5614" y="-1641.92" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="5614" y="-1626.92" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- split_qkv_3&#45;&gt;attn_stage_3_0 -->
<g id="edge107" class="edge">
<title>split_qkv_3&#45;&gt;attn_stage_3_0</title>
<path fill="none" stroke="black" d="M5725.66,-1727.48C5708.03,-1715.89 5689.64,-1703.81 5672.99,-1692.88"/>
<polygon fill="black" stroke="black" points="5674.74,-1689.84 5664.46,-1687.27 5670.9,-1695.69 5674.74,-1689.84"/>
</g>
<!-- send_kv_3_0 -->
<g id="node94" class="node">
<title>send_kv_3_0</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="5877" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="5877" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU0</text>
<text text-anchor="middle" x="5877" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="5877" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- split_qkv_3&#45;&gt;send_kv_3_0 -->
<g id="edge108" class="edge">
<title>split_qkv_3&#45;&gt;send_kv_3_0</title>
<path fill="none" stroke="black" d="M5834.91,-1727.48C5840.3,-1718.08 5845.88,-1708.36 5851.14,-1699.19"/>
<polygon fill="black" stroke="black" points="5854.34,-1700.65 5856.28,-1690.24 5848.27,-1697.17 5854.34,-1700.65"/>
</g>
<!-- send_kv_3_1 -->
<g id="node98" class="node">
<title>send_kv_3_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="6142" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="6142" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU0</text>
<text text-anchor="middle" x="6142" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="6142" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- split_qkv_3&#45;&gt;send_kv_3_1 -->
<g id="edge111" class="edge">
<title>split_qkv_3&#45;&gt;send_kv_3_1</title>
<path fill="none" stroke="black" d="M5919.09,-1737.12C5963.82,-1720.46 6014.28,-1701.68 6055.87,-1686.19"/>
<polygon fill="black" stroke="black" points="6057.27,-1689.41 6065.42,-1682.64 6054.82,-1682.85 6057.27,-1689.41"/>
</g>
<!-- send_kv_3_2 -->
<g id="node102" class="node">
<title>send_kv_3_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="6407" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="6407" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU0</text>
<text text-anchor="middle" x="6407" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="6407" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- split_qkv_3&#45;&gt;send_kv_3_2 -->
<g id="edge115" class="edge">
<title>split_qkv_3&#45;&gt;send_kv_3_2</title>
<path fill="none" stroke="black" d="M5933.77,-1758.17C6028.55,-1741.68 6160.34,-1717.25 6275,-1690.6 6286.02,-1688.04 6297.49,-1685.17 6308.88,-1682.2"/>
<polygon fill="black" stroke="black" points="6310.08,-1685.5 6318.86,-1679.56 6308.3,-1678.73 6310.08,-1685.5"/>
</g>
<!-- send_kv_3_3 -->
<g id="node106" class="node">
<title>send_kv_3_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="5351" cy="-1653.12" rx="123.99" ry="37.45"/>
<text text-anchor="middle" x="5351" y="-1664.42" font-family="Times,serif" font-size="14.00">Send K,V to GPU0</text>
<text text-anchor="middle" x="5351" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="5351" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- split_qkv_3&#45;&gt;send_kv_3_3 -->
<g id="edge119" class="edge">
<title>split_qkv_3&#45;&gt;send_kv_3_3</title>
<path fill="none" stroke="black" d="M5625.24,-1729.92C5565.78,-1713.49 5501.8,-1695.8 5450.6,-1681.65"/>
<polygon fill="black" stroke="black" points="5451.44,-1678.25 5440.87,-1678.96 5449.58,-1685 5451.44,-1678.25"/>
</g>
<!-- accum_3_0 -->
<g id="node95" class="node">
<title>accum_3_0</title>
<polygon fill="lightgray" stroke="black" points="5354.5,-1567.67 5217.5,-1567.67 5217.5,-1514.67 5354.5,-1514.67 5354.5,-1567.67"/>
<text text-anchor="middle" x="5286" y="-1552.47" font-family="Times,serif" font-size="14.00">Initialize Output</text>
<text text-anchor="middle" x="5286" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="5286" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- attn_stage_3_0&#45;&gt;accum_3_0 -->
<g id="edge109" class="edge">
<title>attn_stage_3_0&#45;&gt;accum_3_0</title>
<path fill="none" stroke="black" d="M5497.99,-1619.06C5438.84,-1602.04 5376.53,-1583.79 5363,-1578.65 5357.6,-1576.59 5352.05,-1574.31 5346.53,-1571.93"/>
<polygon fill="black" stroke="black" points="5347.85,-1568.69 5337.29,-1567.83 5345.01,-1575.09 5347.85,-1568.69"/>
</g>
<!-- accum_3_1 -->
<g id="node99" class="node">
<title>accum_3_1</title>
<polygon fill="lightgray" stroke="black" points="5266,-1455.72 5098,-1455.72 5098,-1402.72 5266,-1402.72 5266,-1455.72"/>
<text text-anchor="middle" x="5182" y="-1440.52" font-family="Times,serif" font-size="14.00">Accumulate Output 1</text>
<text text-anchor="middle" x="5182" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="5182" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- accum_3_0&#45;&gt;accum_3_1 -->
<g id="edge112" class="edge">
<title>accum_3_0&#45;&gt;accum_3_1</title>
<path fill="none" stroke="black" d="M5261.88,-1514.67C5247.41,-1499.37 5228.86,-1479.76 5213.28,-1463.28"/>
<polygon fill="black" stroke="black" points="5215.76,-1460.82 5206.35,-1455.96 5210.68,-1465.63 5215.76,-1460.82"/>
</g>
<!-- attn_stage_3_1 -->
<g id="node96" class="node">
<title>attn_stage_3_1</title>
<polygon fill="orange" stroke="black" points="5199,-1575.17 4957,-1575.17 4957,-1507.17 5199,-1507.17 5199,-1575.17"/>
<text text-anchor="middle" x="5078" y="-1559.97" font-family="Times,serif" font-size="14.00">Ring Attention Stage 1</text>
<text text-anchor="middle" x="5078" y="-1544.97" font-family="Times,serif" font-size="14.00">Q3 × K2 × V2</text>
<text text-anchor="middle" x="5078" y="-1529.97" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="5078" y="-1514.97" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- attn_stage_3_1&#45;&gt;accum_3_1 -->
<g id="edge113" class="edge">
<title>attn_stage_3_1&#45;&gt;accum_3_1</title>
<path fill="none" stroke="black" d="M5109.49,-1506.88C5122.5,-1493.12 5137.56,-1477.2 5150.57,-1463.45"/>
<polygon fill="black" stroke="black" points="5153.23,-1465.73 5157.56,-1456.06 5148.14,-1460.92 5153.23,-1465.73"/>
</g>
<!-- recv_kv_3_1 -->
<g id="node97" class="node">
<title>recv_kv_3_1</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="5078" cy="-1653.12" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="5078" y="-1664.42" font-family="Times,serif" font-size="14.00">Receive K,V from GPU2</text>
<text text-anchor="middle" x="5078" y="-1649.42" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="5078" y="-1634.42" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- recv_kv_3_1&#45;&gt;attn_stage_3_1 -->
<g id="edge110" class="edge">
<title>recv_kv_3_1&#45;&gt;attn_stage_3_1</title>
<path fill="none" stroke="black" d="M5078,-1615.51C5078,-1605.87 5078,-1595.37 5078,-1585.41"/>
<polygon fill="black" stroke="black" points="5081.5,-1585.29 5078,-1575.29 5074.5,-1585.29 5081.5,-1585.29"/>
</g>
<!-- accum_3_2 -->
<g id="node103" class="node">
<title>accum_3_2</title>
<polygon fill="lightgray" stroke="black" points="5434,-1347.24 5266,-1347.24 5266,-1294.24 5434,-1294.24 5434,-1347.24"/>
<text text-anchor="middle" x="5350" y="-1332.04" font-family="Times,serif" font-size="14.00">Accumulate Output 2</text>
<text text-anchor="middle" x="5350" y="-1317.04" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="5350" y="-1302.04" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- accum_3_1&#45;&gt;accum_3_2 -->
<g id="edge116" class="edge">
<title>accum_3_1&#45;&gt;accum_3_2</title>
<path fill="none" stroke="black" d="M5222.24,-1402.71C5245.86,-1387.74 5275.88,-1368.72 5300.89,-1352.87"/>
<polygon fill="black" stroke="black" points="5302.93,-1355.71 5309.51,-1347.4 5299.19,-1349.8 5302.93,-1355.71"/>
</g>
<!-- attn_stage_3_2 -->
<g id="node100" class="node">
<title>attn_stage_3_2</title>
<polygon fill="orange" stroke="black" points="5526,-1463.22 5284,-1463.22 5284,-1395.22 5526,-1395.22 5526,-1463.22"/>
<text text-anchor="middle" x="5405" y="-1448.02" font-family="Times,serif" font-size="14.00">Ring Attention Stage 2</text>
<text text-anchor="middle" x="5405" y="-1433.02" font-family="Times,serif" font-size="14.00">Q3 × K1 × V1</text>
<text text-anchor="middle" x="5405" y="-1418.02" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="5405" y="-1403.02" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- attn_stage_3_2&#45;&gt;accum_3_2 -->
<g id="edge117" class="edge">
<title>attn_stage_3_2&#45;&gt;accum_3_2</title>
<path fill="none" stroke="black" d="M5387.9,-1395.11C5381.57,-1382.85 5374.37,-1368.92 5367.96,-1356.52"/>
<polygon fill="black" stroke="black" points="5370.95,-1354.66 5363.25,-1347.38 5364.73,-1357.87 5370.95,-1354.66"/>
</g>
<!-- recv_kv_3_2 -->
<g id="node101" class="node">
<title>recv_kv_3_2</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="5503" cy="-1541.17" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="5503" y="-1552.47" font-family="Times,serif" font-size="14.00">Receive K,V from GPU2</text>
<text text-anchor="middle" x="5503" y="-1537.47" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="5503" y="-1522.47" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- recv_kv_3_2&#45;&gt;attn_stage_3_2 -->
<g id="edge114" class="edge">
<title>recv_kv_3_2&#45;&gt;attn_stage_3_2</title>
<path fill="none" stroke="black" d="M5471.45,-1504.77C5461.81,-1493.96 5451.14,-1481.98 5441.22,-1470.85"/>
<polygon fill="black" stroke="black" points="5443.76,-1468.44 5434.49,-1463.3 5438.53,-1473.1 5443.76,-1468.44"/>
</g>
<!-- accum_3_3 -->
<g id="node107" class="node">
<title>accum_3_3</title>
<polygon fill="lightgray" stroke="black" points="5434,-1249.74 5266,-1249.74 5266,-1196.74 5434,-1196.74 5434,-1249.74"/>
<text text-anchor="middle" x="5350" y="-1234.54" font-family="Times,serif" font-size="14.00">Accumulate Output 3</text>
<text text-anchor="middle" x="5350" y="-1219.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="5350" y="-1204.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- accum_3_2&#45;&gt;accum_3_3 -->
<g id="edge120" class="edge">
<title>accum_3_2&#45;&gt;accum_3_3</title>
<path fill="none" stroke="black" d="M5350,-1294.15C5350,-1283.66 5350,-1271.33 5350,-1259.98"/>
<polygon fill="black" stroke="black" points="5353.5,-1259.9 5350,-1249.9 5346.5,-1259.9 5353.5,-1259.9"/>
</g>
<!-- attn_stage_3_3 -->
<g id="node104" class="node">
<title>attn_stage_3_3</title>
<polygon fill="orange" stroke="black" points="5730,-1354.74 5488,-1354.74 5488,-1286.74 5730,-1286.74 5730,-1354.74"/>
<text text-anchor="middle" x="5609" y="-1339.54" font-family="Times,serif" font-size="14.00">Ring Attention Stage 3</text>
<text text-anchor="middle" x="5609" y="-1324.54" font-family="Times,serif" font-size="14.00">Q3 × K0 × V0</text>
<text text-anchor="middle" x="5609" y="-1309.54" font-family="Times,serif" font-size="14.00">(B, L/4, L/4) × (B, L/4, d_model)</text>
<text text-anchor="middle" x="5609" y="-1294.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- attn_stage_3_3&#45;&gt;accum_3_3 -->
<g id="edge121" class="edge">
<title>attn_stage_3_3&#45;&gt;accum_3_3</title>
<path fill="none" stroke="black" d="M5519.14,-1286.61C5489.74,-1275.77 5457.32,-1263.81 5428.79,-1253.29"/>
<polygon fill="black" stroke="black" points="5429.87,-1249.96 5419.28,-1249.79 5427.45,-1256.53 5429.87,-1249.96"/>
</g>
<!-- recv_kv_3_3 -->
<g id="node105" class="node">
<title>recv_kv_3_3</title>
<ellipse fill="none" stroke="black" stroke-dasharray="5,2" cx="5675" cy="-1429.22" rx="130.63" ry="37.45"/>
<text text-anchor="middle" x="5675" y="-1440.52" font-family="Times,serif" font-size="14.00">Receive K,V from GPU2</text>
<text text-anchor="middle" x="5675" y="-1425.52" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) each</text>
<text text-anchor="middle" x="5675" y="-1410.52" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- recv_kv_3_3&#45;&gt;attn_stage_3_3 -->
<g id="edge118" class="edge">
<title>recv_kv_3_3&#45;&gt;attn_stage_3_3</title>
<path fill="none" stroke="black" d="M5652.66,-1392.17C5646.93,-1382.93 5640.72,-1372.92 5634.84,-1363.42"/>
<polygon fill="black" stroke="black" points="5637.79,-1361.54 5629.54,-1354.88 5631.84,-1365.23 5637.79,-1361.54"/>
</g>
<!-- output_proj_3 -->
<g id="node108" class="node">
<title>output_proj_3</title>
<polygon fill="lightblue" stroke="black" points="5337,-1159.74 5053,-1159.74 5053,-1106.74 5337,-1106.74 5337,-1159.74"/>
<text text-anchor="middle" x="5195" y="-1144.54" font-family="Times,serif" font-size="14.00">Output Projection</text>
<text text-anchor="middle" x="5195" y="-1129.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="5195" y="-1114.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- accum_3_3&#45;&gt;output_proj_3 -->
<g id="edge122" class="edge">
<title>accum_3_3&#45;&gt;output_proj_3</title>
<path fill="none" stroke="black" d="M5304.75,-1196.55C5287.24,-1186.61 5267.06,-1175.15 5248.82,-1164.79"/>
<polygon fill="black" stroke="black" points="5250.46,-1161.7 5240.04,-1159.81 5247.01,-1167.79 5250.46,-1161.7"/>
</g>
<!-- output_proj_3&#45;&gt;residual_3 -->
<g id="edge124" class="edge">
<title>output_proj_3&#45;&gt;residual_3</title>
<path fill="none" stroke="black" d="M5114.8,-1106.67C5077.83,-1094.88 5034.12,-1080.94 4997.38,-1069.23"/>
<polygon fill="black" stroke="black" points="4998.3,-1065.85 4987.71,-1066.15 4996.17,-1072.52 4998.3,-1065.85"/>
</g>
<!-- ln1_3 -->
<g id="node110" class="node">
<title>ln1_3</title>
<polygon fill="lightyellow" stroke="black" points="4874.5,-979.74 4737.5,-979.74 4737.5,-926.74 4874.5,-926.74 4874.5,-979.74"/>
<text text-anchor="middle" x="4806" y="-964.54" font-family="Times,serif" font-size="14.00">Layer Norm 1</text>
<text text-anchor="middle" x="4806" y="-949.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="4806" y="-934.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- residual_3&#45;&gt;ln1_3 -->
<g id="edge125" class="edge">
<title>residual_3&#45;&gt;ln1_3</title>
<path fill="none" stroke="black" d="M4886.01,-1016.55C4873.83,-1007.06 4859.87,-996.19 4847.06,-986.21"/>
<polygon fill="black" stroke="black" points="4848.87,-983.19 4838.83,-979.81 4844.57,-988.72 4848.87,-983.19"/>
</g>
<!-- gate_3 -->
<g id="node111" class="node">
<title>gate_3</title>
<polygon fill="purple" stroke="black" points="4922.5,-889.74 4689.5,-889.74 4689.5,-836.74 4922.5,-836.74 4922.5,-889.74"/>
<text text-anchor="middle" x="4806" y="-874.54" font-family="Times,serif" font-size="14.00">MoE Gate</text>
<text text-anchor="middle" x="4806" y="-859.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, 8)</text>
<text text-anchor="middle" x="4806" y="-844.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- ln1_3&#45;&gt;gate_3 -->
<g id="edge126" class="edge">
<title>ln1_3&#45;&gt;gate_3</title>
<path fill="none" stroke="black" d="M4806,-926.31C4806,-918.08 4806,-908.82 4806,-900.02"/>
<polygon fill="black" stroke="black" points="4809.5,-899.98 4806,-889.98 4802.5,-899.98 4809.5,-899.98"/>
</g>
<!-- expert_3_0 -->
<g id="node112" class="node">
<title>expert_3_0</title>
<polygon fill="lightcoral" stroke="black" points="4770,-789.74 4278,-789.74 4278,-736.74 4770,-736.74 4770,-789.74"/>
<text text-anchor="middle" x="4524" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 0</text>
<text text-anchor="middle" x="4524" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="4524" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- ln1_3&#45;&gt;expert_3_0 -->
<g id="edge128" class="edge">
<title>ln1_3&#45;&gt;expert_3_0</title>
<path fill="none" stroke="black" d="M4748.61,-926.68C4726.87,-916.2 4702.26,-903.34 4681,-889.74 4637.01,-861.61 4590.81,-823.49 4560.01,-796.67"/>
<polygon fill="black" stroke="black" points="4561.96,-793.72 4552.13,-789.76 4557.35,-798.99 4561.96,-793.72"/>
</g>
<!-- expert_3_1 -->
<g id="node113" class="node">
<title>expert_3_1</title>
<polygon fill="lightcoral" stroke="black" points="5280,-789.74 4788,-789.74 4788,-736.74 5280,-736.74 5280,-789.74"/>
<text text-anchor="middle" x="5034" y="-774.54" font-family="Times,serif" font-size="14.00">Expert 1</text>
<text text-anchor="middle" x="5034" y="-759.54" font-family="Times,serif" font-size="14.00">(B, selected_tokens/2, d_model) &#45;&gt; (B, selected_tokens/2, d_model)</text>
<text text-anchor="middle" x="5034" y="-744.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- ln1_3&#45;&gt;expert_3_1 -->
<g id="edge130" class="edge">
<title>ln1_3&#45;&gt;expert_3_1</title>
<path fill="none" stroke="black" d="M4870.19,-926.62C4890.99,-916.74 4913.45,-904.28 4932,-889.74 4964.7,-864.11 4993.68,-826.17 5012.31,-798.72"/>
<polygon fill="black" stroke="black" points="5015.35,-800.47 5017.99,-790.21 5009.53,-796.59 5015.35,-800.47"/>
</g>
<!-- residual2_3 -->
<g id="node116" class="node">
<title>residual2_3</title>
<polygon fill="pink" stroke="black" points="4318.5,-436.74 4181.5,-436.74 4181.5,-383.74 4318.5,-383.74 4318.5,-436.74"/>
<text text-anchor="middle" x="4250" y="-421.54" font-family="Times,serif" font-size="14.00">Residual Add 2</text>
<text text-anchor="middle" x="4250" y="-406.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="4250" y="-391.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- ln1_3&#45;&gt;residual2_3 -->
<g id="edge134" class="edge">
<title>ln1_3&#45;&gt;residual2_3</title>
<path fill="none" stroke="black" d="M4737.27,-948.43C4588.51,-939.26 4250,-913.04 4250,-864.24 4250,-864.24 4250,-864.24 4250,-499.24 4250,-482.07 4250,-463.02 4250,-447.04"/>
<polygon fill="black" stroke="black" points="4253.5,-447.04 4250,-437.04 4246.5,-447.04 4253.5,-447.04"/>
</g>
<!-- gate_3&#45;&gt;expert_3_0 -->
<g id="edge127" class="edge">
<title>gate_3&#45;&gt;expert_3_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M4732.28,-836.62C4693.98,-823.31 4647.04,-807 4607.42,-793.23"/>
<polygon fill="black" stroke="black" points="4608.38,-789.86 4597.78,-789.88 4606.08,-796.47 4608.38,-789.86"/>
<text text-anchor="middle" x="4705" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- gate_3&#45;&gt;expert_3_1 -->
<g id="edge129" class="edge">
<title>gate_3&#45;&gt;expert_3_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M4862.33,-836.64C4882.93,-827.4 4906.46,-816.97 4928,-807.74 4938.79,-803.12 4950.23,-798.32 4961.45,-793.67"/>
<polygon fill="black" stroke="black" points="4962.9,-796.85 4970.81,-789.8 4960.23,-790.38 4962.9,-796.85"/>
<text text-anchor="middle" x="4960" y="-810.74" font-family="Times,serif" font-size="10.00">route tokens</text>
</g>
<!-- expert_agg_3 -->
<g id="node114" class="node">
<title>expert_agg_3</title>
<polygon fill="yellow" stroke="black" points="4687.61,-699.74 4427.34,-699.74 4360.39,-563.74 4620.66,-563.74 4687.61,-699.74"/>
<text text-anchor="middle" x="4524" y="-650.54" font-family="Times,serif" font-size="14.00">Expert Aggregation</text>
<text text-anchor="middle" x="4524" y="-635.54" font-family="Times,serif" font-size="14.00">Combine 2 experts</text>
<text text-anchor="middle" x="4524" y="-620.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="4524" y="-605.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- expert_3_0&#45;&gt;expert_agg_3 -->
<g id="edge131" class="edge">
<title>expert_3_0&#45;&gt;expert_agg_3</title>
<path fill="none" stroke="black" d="M4524,-736.66C4524,-728.72 4524,-719.53 4524,-709.97"/>
<polygon fill="black" stroke="black" points="4527.5,-709.9 4524,-699.9 4520.5,-709.9 4527.5,-709.9"/>
</g>
<!-- expert_3_1&#45;&gt;expert_agg_3 -->
<g id="edge132" class="edge">
<title>expert_3_1&#45;&gt;expert_agg_3</title>
<path fill="none" stroke="black" d="M4933.54,-736.73C4862.3,-718.64 4765.21,-693.99 4683.44,-673.23"/>
<polygon fill="black" stroke="black" points="4684.1,-669.78 4673.55,-670.71 4682.38,-676.57 4684.1,-669.78"/>
</g>
<!-- moe_output_3 -->
<g id="node115" class="node">
<title>moe_output_3</title>
<polygon fill="lightblue" stroke="black" points="4614,-526.74 4330,-526.74 4330,-473.74 4614,-473.74 4614,-526.74"/>
<text text-anchor="middle" x="4472" y="-511.54" font-family="Times,serif" font-size="14.00">MoE Output Projection</text>
<text text-anchor="middle" x="4472" y="-496.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model) &#45;&gt; (B, L/4, d_model)</text>
<text text-anchor="middle" x="4472" y="-481.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- expert_agg_3&#45;&gt;moe_output_3 -->
<g id="edge133" class="edge">
<title>expert_agg_3&#45;&gt;moe_output_3</title>
<path fill="none" stroke="black" d="M4497.09,-563.71C4493.31,-554.31 4489.56,-544.97 4486.15,-536.49"/>
<polygon fill="black" stroke="black" points="4489.31,-534.95 4482.33,-526.98 4482.81,-537.56 4489.31,-534.95"/>
</g>
<!-- moe_output_3&#45;&gt;residual2_3 -->
<g id="edge135" class="edge">
<title>moe_output_3&#45;&gt;residual2_3</title>
<path fill="none" stroke="black" d="M4407.49,-473.67C4381.38,-463.32 4351.08,-451.31 4324.07,-440.6"/>
<polygon fill="black" stroke="black" points="4325.26,-437.31 4314.67,-436.88 4322.68,-443.81 4325.26,-437.31"/>
</g>
<!-- ln2_3 -->
<g id="node117" class="node">
<title>ln2_3</title>
<polygon fill="lightyellow" stroke="black" points="3076.5,-346.74 2939.5,-346.74 2939.5,-293.74 3076.5,-293.74 3076.5,-346.74"/>
<text text-anchor="middle" x="3008" y="-331.54" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="3008" y="-316.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="3008" y="-301.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- residual2_3&#45;&gt;ln2_3 -->
<g id="edge136" class="edge">
<title>residual2_3&#45;&gt;ln2_3</title>
<path fill="none" stroke="black" d="M4181.46,-404.38C3967.72,-389.24 3314.16,-342.93 3086.89,-326.83"/>
<polygon fill="black" stroke="black" points="3086.94,-323.32 3076.71,-326.11 3086.44,-330.31 3086.94,-323.32"/>
</g>
<!-- output_seg_3 -->
<g id="node118" class="node">
<title>output_seg_3</title>
<polygon fill="lightcyan" stroke="black" points="2919.5,-256.74 2770.5,-256.74 2770.5,-203.74 2919.5,-203.74 2919.5,-256.74"/>
<text text-anchor="middle" x="2845" y="-241.54" font-family="Times,serif" font-size="14.00">Output Segment 3</text>
<text text-anchor="middle" x="2845" y="-226.54" font-family="Times,serif" font-size="14.00">(B, L/4, d_model)</text>
<text text-anchor="middle" x="2845" y="-211.54" font-family="Times,serif" font-size="14.00">GPU_3</text>
</g>
<!-- ln2_3&#45;&gt;output_seg_3 -->
<g id="edge137" class="edge">
<title>ln2_3&#45;&gt;output_seg_3</title>
<path fill="none" stroke="black" d="M2960.42,-293.55C2941.92,-283.56 2920.59,-272.05 2901.33,-261.65"/>
<polygon fill="black" stroke="black" points="2902.82,-258.48 2892.36,-256.81 2899.5,-264.64 2902.82,-258.48"/>
</g>
<!-- output_seg_3&#45;&gt;gather -->
<g id="edge141" class="edge">
<title>output_seg_3&#45;&gt;gather</title>
<path fill="none" stroke="black" d="M2770.43,-212.64C2716.93,-200.73 2642.52,-184.17 2574.27,-168.98"/>
<polygon fill="black" stroke="black" points="2574.77,-165.5 2564.25,-166.75 2573.25,-172.34 2574.77,-165.5"/>
</g>
<!-- output_total -->
<g id="node120" class="node">
<title>output_total</title>
<ellipse fill="lightgreen" stroke="black" cx="2398" cy="-26.87" rx="87.86" ry="26.74"/>
<text text-anchor="middle" x="2398" y="-30.67" font-family="Times,serif" font-size="14.00">Final Output</text>
<text text-anchor="middle" x="2398" y="-15.67" font-family="Times,serif" font-size="14.00">(B, L, d_model)</text>
</g>
<!-- gather&#45;&gt;output_total -->
<g id="edge142" class="edge">
<title>gather&#45;&gt;output_total</title>
<path fill="none" stroke="black" d="M2398,-90.55C2398,-81.88 2398,-72.65 2398,-64.03"/>
<polygon fill="black" stroke="black" points="2401.5,-63.87 2398,-53.87 2394.5,-63.87 2401.5,-63.87"/>
</g>
</g>
</svg>
